<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Obituary Builders - Account</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Merriweather&display=swap" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap"
    rel="stylesheet" />
  <!-- SortableJS for Drag & Drop -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
  <!-- Cropper.js for Photo Editing -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
  <!-- jsPDF for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body {
      font-family: "Merriweather", serif;
      /* background-image is now set by JavaScript */
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      transition: background-image 0.5s ease-in-out;
    }

    .font-serif {
      font-family: 'Playfair Display', serif;
    }

    .view {
      display: none;
    }

    .form-step {
      display: none;
    }

    .form-step.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .form-step.active {
      animation: fadeIn .5s ease-in-out;
    }

    .sortable-ghost {
      opacity: .4;
      background: #cce0ff;
    }

    .dynamic-entry {
      cursor: grab;
    }

    .gemini-button::after {
      content: '✨';
      margin-left: .25rem;
      display: inline-block;
    }

    @media print {
      .dot-row {
        display: flex;
        gap: 1rem;
      }

      .dot-leader {
        flex: 1;
        border-bottom: 1px dotted #444;
        transform: translateY(-.2rem);
        margin: 0 .25rem;
      }
    }

    .photo-upload-container {
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
      background-size: cover;
      background-position: center;
    }

    .photo-preview-overlay {
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
    }

    .photo-upload-container:hover .photo-preview-overlay {
      opacity: 1;
    }

    .upload-progress {
      transition: all 0.3s ease;
    }

    .progress-bar {
      transition: width 0.2s ease-out;
      background: linear-gradient(90deg, #4f46e5, #7c3aed);
    }

    .upload-success {
      animation: uploadSuccess 0.5s ease-out;
    }

    @keyframes uploadSuccess {
      0% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.05);
      }

      100% {
        transform: scale(1);
      }
    }

    .error-border {
      border-color: #ef4444 !important;
    }

    .success-border {
      border-color: #10b981 !important;
    }

    .photo-editor-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .photo-editor-container {
      background: white;
      border-radius: 12px;
      padding: 24px;
      width: 90%;
      max-width: 800px;
      max-height: 90%;
      overflow: auto;
    }

    .cropper-container {
      max-height: 400px;
      margin: 20px 0;
    }

    .editor-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 20px 0;
      justify-content: center;
    }

    .editor-btn {
      padding: 8px 16px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      background: white;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }

    .editor-btn:hover {
      background: #f3f4f6;
      border-color: #9ca3af;
    }

    .editor-btn.active {
      background: #4f46e5;
      color: white;
      border-color: #4f46e5;
    }

    #venue-suggestions {
      position: absolute;
      background: white;
      border: 1px solid #e2e8f0;
      border-top: none;
      border-radius: 0 0 0.5rem 0.5rem;
      width: 100%;
      z-index: 10;
      max-height: 200px;
      overflow-y: auto;
    }

    #venue-suggestions div {
      padding: 0.75rem 1rem;
      cursor: pointer;
    }

    #venue-suggestions div:hover {
      background-color: #f7fafc;
    }

    .life-story .field-instructions {
      font-size: 0.9rem;
      color: #0b5ed7;
      /* Muted blue for visibility and accessibility */
      display: block;
      margin-top: 0.25rem;
    }

    .page-intro-box {
      background-color: #f8f9fa;
      /* light gray shading */
      border: 1px solid #dee2e6;
      /* subtle border */
      padding: 1rem;
      margin-bottom: 1rem;
      border-radius: 6px;
      font-size: 1.05rem;
      color: #2c3e50;
      /* dark slate gray text */
    }

    .life-story .field-error {
      display: block;
      margin-top: 0.25rem;
      font-size: 0.9rem;
      color: #b00020;
      /* accessible red for errors */
    }

    .life-story [aria-invalid="true"] {
      outline: 2px solid #b00020;
      outline-offset: 2px;
    }

    #step-indicator {
      position: sticky;
      top: 0;
      z-index: 50;
      background: white;
      border-bottom: 2px solid #e5e7eb;
      padding: 1rem 0;
      margin-bottom: 1.5rem;
    }

    .pdf-preview-container {
      background: #f3f4f6;
      padding: 2rem;
      border-radius: 0.5rem;
      margin-top: 2rem;
    }

    .pdf-page {
      background: white;
      width: 8.5in;
      height: 11in;
      margin: 0 auto 2rem;
      padding: 1in;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      page-break-after: always;
    }
  </style>

</head>

<body class="text-gray-800 antialiased">
  <div id="app-container" class="container mx-auto min-h-screen px-4 py-8">
    <div id="loading-view" class="view flex items-center justify-center min-h-screen">
      <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-indigo-600"></div>
    </div>

    <div id="login-view" class="view flex items-center justify-center min-h-screen">
      <div
        class="w-full max-w-md bg-white/90 backdrop-blur-sm p-8 md:p-10 rounded-2xl shadow-lg border border-gray-200">
        <div class="text-center mb-8">
          <img src="https://obituarybuilders.com/logos/OBITUARY-2.png" alt="Obituary Builders Logo"
            class="mx-auto h-48 w-auto mb-6">
          <h1 class="text-3xl font-serif text-gray-800">Honoring Every Life,<br>With Care.</h1>
          <p class="text-gray-500 mt-2">Sign in or create an account to begin.</p>
        </div>
        <form id="login-form">
          <div id="login-error"
            class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mb-4 text-sm"></div>
          <div class="mb-4">
            <label for="login-email" class="block text-sm font-medium text-gray-600 mb-1">Email</label>
            <input type="email" id="login-email"
              class="w-full px-4 py-2 bg-gray-50 border rounded-lg focus:ring-2 focus:ring-indigo-500" required />
          </div>
          <div class="mb-6">
            <label for="login-password" class="block text-sm font-medium text-gray-600 mb-1">Password</label>
            <input type="password" id="login-password"
              class="w-full px-4 py-2 bg-gray-50 border rounded-lg focus:ring-2 focus:ring-indigo-500" required />
          </div>
          <button type="submit"
            class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 shadow-md">Sign
            In</button>
        </form>
        <p class="text-center text-sm text-gray-500 mt-6">
          Don't have an account?
          <a href="#" id="show-signup" class="font-medium text-indigo-600 hover:text-indigo-500">Sign up</a>
        </p>
      </div>
    </div>

    <div id="signup-view" class="view flex items-center justify-center min-h-screen">
      <div
        class="w-full max-w-md bg-white/90 backdrop-blur-sm p-8 md:p-10 rounded-2xl shadow-lg border border-gray-200">
        <div class="text-center mb-8">
          <h1 class="text-3xl font-serif text-gray-800">Create Your Account</h1>
          <p class="text-gray-500 mt-2">Start creating a beautiful tribute.</p>
        </div>
        <form id="signup-form">
          <div id="signup-error"
            class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mb-4 text-sm"></div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div><label for="signup-firstname" class="block text-sm font-medium text-gray-600 mb-1">First
                Name</label><input type="text" id="signup-firstname"
                class="w-full px-4 py-2 bg-gray-50 border rounded-lg focus:ring-2 focus:ring-indigo-500" required />
            </div>
            <div><label for="signup-lastname" class="block text-sm font-medium text-gray-600 mb-1">Last
                Name</label><input type="text" id="signup-lastname"
                class="w-full px-4 py-2 bg-gray-50 border rounded-lg focus:ring-2 focus:ring-indigo-500" required />
            </div>
          </div>
          <div class="mb-4"><label for="signup-street" class="block text-sm font-medium text-gray-600 mb-1">Street
              Address</label><input type="text" id="signup-street"
              class="w-full px-4 py-2 bg-gray-50 border rounded-lg focus:ring-2 focus:ring-indigo-500" required /></div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div><label for="signup-city" class="block text-sm font-medium text-gray-600 mb-1">City</label><input
                type="text" id="signup-city"
                class="w-full px-4 py-2 bg-gray-50 border rounded-lg focus:ring-2 focus:ring-indigo-500" required />
            </div>
            <div><label for="signup-state" class="block text-sm font-medium text-gray-600 mb-1">State</label><input
                type="text" id="signup-state"
                class="w-full px-4 py-2 bg-gray-50 border rounded-lg focus:ring-2 focus:ring-indigo-500" required />
            </div>
            <div><label for="signup-zip" class="block text-sm font-medium text-gray-600 mb-1">Zip</label><input
                type="text" id="signup-zip"
                class="w-full px-4 py-2 bg-gray-50 border rounded-lg focus:ring-2 focus:ring-indigo-500" required />
            </div>
          </div>
          <div class="mb-4"><label for="signup-phone"
              class="block text-sm font-medium text-gray-600 mb-1">Phone</label><input type="tel" id="signup-phone"
              class="w-full px-4 py-2 bg-gray-50 border rounded-lg focus:ring-2 focus:ring-indigo-500" required /></div>
          <div class="mb-4"><label for="signup-email"
              class="block text-sm font-medium text-gray-600 mb-1">Email</label><input type="email" id="signup-email"
              class="w-full px-4 py-2 bg-gray-50 border rounded-lg focus:ring-2 focus:ring-indigo-500" required /></div>
          <div class="mb-6"><label for="signup-password"
              class="block text-sm font-medium text-gray-600 mb-1">Password</label><input type="password"
              id="signup-password"
              class="w-full px-4 py-2 bg-gray-50 border rounded-lg focus:ring-2 focus:ring-indigo-500" required
              minlength="6" />
            <p class="text-xs text-gray-500 mt-1">6+ characters.</p>
          </div>
          <div class="mt-6 mb-4">
            <label class="flex items-start">
              <input type="checkbox" id="signup-terms" name="terms" required
                class="mt-1 h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
              <span class="ml-3 text-sm text-gray-600">By creating an account, you agree to our <a href="#"
                  class="font-medium text-indigo-600 hover:text-indigo-500">Terms of Service</a> and <a href="#"
                  class="font-medium text-indigo-600 hover:text-indigo-500">Privacy Policy</a>.</span>
            </label>
          </div>
          <button type="submit"
            class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 shadow-md">Create
            Account</button>
        </form>
        <p class="text-center text-sm text-gray-500 mt-6">Already have an account? <a href="#" id="show-login"
            class="font-medium text-indigo-600 hover:text-indigo-500">Sign in</a></p>
      </div>
    </div>

    <div id="dashboard-view" class="view w-full max-w-6xl mx-auto">
      <div class="bg-white p-8 md:p-10 rounded-2xl shadow-lg border border-gray-200">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8">
          <div class="mb-4 sm:mb-0">
            <h1 class="text-3xl font-serif text-gray-800">My Dashboard</h1>
            <p class="text-gray-500 mt-1">Welcome, <span id="user-name" class="font-medium"></span></p>
          </div>
          <div class="flex items-center gap-4">
            <button id="create-new-button"
              class="bg-indigo-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-indigo-700 shadow-md">+ New
              Program</button>
            <button id="logout-button"
              class="bg-gray-700 text-white font-bold py-2 px-5 rounded-lg hover:bg-gray-800">Log Out</button>
          </div>
        </div>
        <div id="obituaries-list-container"></div>
        <div id="no-obituaries-view" class="text-center py-16 border-2 border-dashed rounded-lg">
          <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" />
          </svg>
          <h2 class="mt-2 text-xl font-semibold text-gray-700">No Programs Yet</h2>
          <p class="mt-1 text-gray-500">Get started by creating a new funeral program.</p>
        </div>
      </div>
    </div>

    <div id="form-view" class="view w-full max-w-3xl mx-auto">
      <div class="bg-white p-8 md:p-10 rounded-2xl shadow-lg border border-gray-200">
        <form id="obituary-form" novalidate>
          <input type="hidden" name="frontCover.photoUrl" id="photo-url-input" />
          <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-serif text-gray-800">Obituary Builder</h1>
            <button type="button" id="form-back-to-dashboard" class="text-sm text-gray-600 hover:text-indigo-600">&larr;
              Back to Dashboard</button>
          </div>
          
          <!-- Step Indicator -->
          <div id="step-indicator" class="mb-6">
            <div class="text-center">
              <h2 class="text-xl font-bold text-gray-800" id="current-step-title">Step 1: Front Cover Details</h2>
              <p class="text-sm text-gray-600 mt-1" id="step-count-display">Step 1 of 6</p>
            </div>
          </div>
          
          <div class="mb-8">
            <div class="flex justify-end mb-1">
              <span id="step-counter" class="text-sm font-medium text-indigo-700"></span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2.5">
              <div id="progress-bar" class="bg-indigo-600 h-2.5 rounded-full" style="width:0%"></div>
            </div>
          </div>

          <div id="step-1" class="form-step active">
            <h2 class="text-xl font-semibold mb-6 text-gray-700 border-b pb-3">Front Cover Details</h2>
            <div class="space-y-6">
              <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">Cover Title <span
                    class="text-red-500">*</span></label>
                <select name="frontCover.title" class="w-full p-2 border rounded-lg bg-white" required></select>
                <p class="text-xs text-gray-500 mt-1">Select the main heading for the program cover.</p>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label for="prefix-select" class="block text-sm font-medium text-gray-600 mb-1">Prefix</label>
                  <select name="frontCover.prefix" id="prefix-select"
                    class="w-full p-2 border rounded-lg bg-white"></select>
                  <p class="text-xs text-gray-500 mt-1">Select an optional title. The list is grouped by category for
                    your convenience.</p>
                </div>
                <div class="col-span-2">
                  <label class="block text-sm font-medium text-gray-600 mb-1">Deceased's Full Name <span
                      class="text-red-500">*</span></label>
                  <input type="text" name="frontCover.fullName" class="w-full p-2 border rounded-lg"
                    placeholder="Deceased's full name" required />
                  <p class="text-xs text-gray-500 mt-1">Please enter the name exactly as it should appear on the
                    program.</p>
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">Cover Photo</label>
                <div id="photo-upload-area"
                  class="mt-1 h-48 flex items-center justify-center bg-gray-50 border-2 border-gray-300 border-dashed rounded-lg photo-upload-container">
                  <div id="photo-placeholder" class="space-y-1 text-center">
                    <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48"
                      aria-hidden="true">
                      <path
                        d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                    </svg>
                    <div class="flex text-sm text-gray-600">
                      <label for="photo-upload-input"
                        class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-indigo-500">
                        <span>Upload a photo</span>
                        <input id="photo-upload-input" name="photo-upload" type="file" class="sr-only" accept="image/*">
                      </label>
                      <p class="pl-1">or drag and drop</p>
                    </div>
                    <p class="text-xs text-gray-500">PNG, JPG, GIF up to 10MB</p>
                  </div>
                  <div id="photo-preview-overlay"
                    class="photo-preview-overlay absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center gap-4">
                    <button type="button" id="edit-photo-btn"
                      class="p-2 bg-white rounded-full shadow-md hover:bg-gray-200" title="Edit Photo">
                      <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L16.732 3.732z">
                        </path>
                      </svg>
                    </button>
                    <button type="button" id="change-photo-btn"
                      class="p-2 bg-white rounded-full shadow-md hover:bg-gray-200" title="Change Photo">
                      <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M4 4v5h5M20 20v-5h-5M4 20h5v-5M20 4h-5v5"></path>
                      </svg>
                    </button>
                    <button type="button" id="remove-photo-btn"
                      class="p-2 bg-white rounded-full shadow-md hover:bg-gray-200" title="Remove Photo">
                      <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                        </path>
                      </svg>
                    </button>
                  </div>
                </div>
                <div id="photo-upload-progress" class="hidden mt-3 upload-progress">
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-gray-700">Uploading photo...</span>
                    <span id="upload-percentage" class="text-sm text-gray-600">0%</span>
                  </div>
                  <div class="w-full bg-gray-200 rounded-full h-3 shadow-inner">
                    <div id="photo-progress-bar" class="progress-bar h-3 rounded-full shadow-sm" style="width: 0%">
                    </div>
                  </div>
                  <div class="flex items-center mt-2">
                    <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-indigo-600" xmlns="http://www.w3.org/2000/svg"
                      fill="none" viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                      </path>
                    </svg>
                    <span id="upload-status" class="text-sm text-gray-600">Processing...</span>
                  </div>
                </div>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label class="block text-sm font-medium text-gray-600 mb-1">Sunrise (DOB) <span
                      class="text-red-500">*</span></label>
                  <input type="date" name="frontCover.dob" class="w-full p-2 border rounded-lg" data-format-target="dob"
                    required />
                  <p id="dob-formatted" class="text-sm text-indigo-600 font-medium mt-1 pl-1 h-5"></p>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-600 mb-1">Sunset (DOP) <span
                      class="text-red-500">*</span></label>
                  <input type="date" name="frontCover.dop" class="w-full p-2 border rounded-lg" data-format-target="dop"
                    required />
                  <p id="dop-formatted" class="text-sm text-indigo-600 font-medium mt-1 pl-1 h-5"></p>
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">Date of Funeral</label>
                <input type="date" name="frontCover.service.dateRaw" class="w-full p-2 border rounded-lg"
                  data-format-target="funeralDate" />
                <p id="funeral-date-formatted" class="text-sm text-indigo-600 font-medium mt-1 pl-1 h-5"></p>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-600 mb-2">Time of Funeral <span
                    class="text-red-500">*</span></label>
                <input type="time" name="frontCover.service.timeStandard" class="w-full p-2 border rounded-lg"
                  data-format-target="time" required />
                <p id="time-formatted" class="text-sm text-indigo-600 font-medium mt-1 pl-1 h-5"></p>
              </div>

              <div class="space-y-2">
                <label class="block text-sm font-medium text-gray-600">Funeral Location <span
                    class="text-red-500">*</span></label>
                <div class="relative">
                  <input type="text" name="frontCover.venue.name" placeholder="Name of Church or Venue"
                    class="w-full p-2 border rounded-lg" required />
                  <div id="venue-suggestions" class="hidden"></div>
                </div>
                <p class="text-xs text-gray-500 mt-1">Start typing to search for a known venue or enter a new one.</p>
                <input type="text" name="frontCover.venue.street" placeholder="Street Address"
                  class="w-full p-2 border rounded-lg" required />
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                  <input type="text" name="frontCover.venue.city" placeholder="City"
                    class="w-full p-2 border rounded-lg" required />
                  <input type="text" name="frontCover.venue.state" placeholder="State"
                    class="w-full p-2 border rounded-lg" required />
                  <input type="text" name="frontCover.venue.zip" placeholder="Zip" class="w-full p-2 border rounded-lg"
                    required />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-600 mb-1 mt-2">Venue Type <span
                      class="text-red-500">*</span></label>
                  <select name="frontCover.venue.type"
                    class="w-full p-2 border rounded-lg bg-gray-50 focus:ring-2 focus:ring-indigo-500" required>
                    <option value="">Select Venue Type</option>
                    <option value="Funeral Home">Funeral Home</option>
                    <option value="Church">Church</option>
                    <option value="Chapel">Chapel</option>
                    <option value="Cemetery / Graveside">Cemetery / Graveside</option>
                    <option value="Family Home / Residence">Family Home / Residence</option>
                    <option value="Community Center">Community Center</option>
                    <option value="Mausoleum">Mausoleum</option>
                    <option value="Veterans Hall / Lodge">Veterans Hall / Lodge</option>
                    <option value="Event Center / Banquet Hall">Event Center / Banquet Hall</option>
                    <option value="Park / Garden">Park / Garden</option>
                    <option value="Cultural Center">Cultural Center</option>
                    <option value="Other">Other</option>
                  </select>
                  <p class="text-xs text-gray-500 mt-1">This is for categorization and will not appear on the program.
                  </p>
                </div>
                <div id="other-venue-type-container" class="mt-2 hidden">
                  <label class="block text-sm font-medium text-gray-600 mb-1">Please Specify Venue Type <span
                      class="text-red-500">*</span></label>
                  <input type="text" name="frontCover.venue.otherType"
                    class="w-full p-2 border rounded-lg bg-gray-50 focus:ring-2 focus:ring-indigo-500">
                </div>
              </div>

              <div>
                <label for="host-pastor" class="block text-sm font-medium text-gray-600 mb-1">Host Pastor</label>
                <input id="host-pastor" type="text" name="frontCover.venue.pastor"
                  placeholder="e.g., Bishop Aubrey L. White, Pastor" class="w-full p-2 border rounded-lg" />
                <p class="text-xs text-gray-500 mt-1">Optional. The pastor of the church where the service is held.</p>
              </div>

              <div>
                <label for="officiant" class="block text-sm font-medium text-gray-600 mb-1">Officiant <span
                    class="text-red-500">*</span></label>
                <input id="officiant" type="text" name="frontCover.officiant" placeholder="Name of Officiant"
                  class="w-full p-2 border rounded-lg" required />
                <p class="text-xs text-gray-500 mt-1">The person conducting the service. Include titles if applicable
                  (e.g., Rev., Dr.).</p>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-600 mb-2">Is the Officiant also the Eulogist? <span
                    class="text-red-500">*</span></label>
                <div class="flex items-center space-x-4">
                  <label><input type="radio" name="eulogistSame" value="yes" class="mr-1" checked /> Yes</label>
                  <label><input type="radio" name="eulogistSame" value="no" class="mr-1" /> No</label>
                </div>
                <div id="eulogist-input-container" class="mt-2 hidden">
                  <label for="eulogist" class="block text-sm font-medium text-gray-600 mb-1">Eulogist</label>
                  <input id="eulogist" type="text" name="frontCover.eulogist" placeholder="Name of Eulogist"
                    class="w-full p-2 border rounded-lg" />
                  <p class="text-xs text-gray-500 mt-1">The person delivering the eulogy. Include titles if applicable.
                  </p>
                </div>
              </div>
            </div>

            <div class="mt-8 flex justify-end">
              <div>
                <button type="button"
                  class="save-progress-button bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">Save</button>
                <button type="button"
                  class="next-button bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700 ml-2">Next</button>
              </div>
            </div>
          </div>

          <div id="step-2" class="form-step life-story"">
            <h2 class=" text-xl font-semibold mb-6 text-gray-700 border-b pb-3">Life Story Information</h2>
            <div class="page-intro">
              <div class="page-intro-box">This page collects detailed information about your loved one’s life story. The
                information you provide here will be used to create a complete and meaningful obituary. Please take your
                time to fill out each section carefully. If some fields do not apply, you may leave them blank. Some
                items may seem repetitive, but this is necessary for the system to generate a well-written and
                appropriate life story.</div>
            </div>

            <div class="space-y-8">

              <!-- Tone Selection -->
              <div class="space-y-4">
                <h3 class="text-lg font-medium text-gray-800 border-b border-gray-200 pb-2">Obituary Tone</h3>
                <div>
                  <label for="obituary-tone" class="block text-sm font-medium text-gray-600 mb-1">Select the tone for
                    the obituary</label>
                  <select id="obituary-tone" name="tone.style" class="w-full p-2 border rounded-lg bg-white">
                    <option value="">Select Tone</option>
                    <option value="Traditional and Formal">Traditional and Formal</option>
                    <option value="Warm and Personal">Warm and Personal</option>
                    <option value="Celebratory and Uplifting">Celebratory and Uplifting</option>
                    <option value="Spiritual and Faith-Centered">Spiritual and Faith-Centered</option>
                    <option value="Simple and Dignified">Simple and Dignified</option>
                    <option value="Storytelling and Narrative">Storytelling and Narrative</option>
                  </select>
                </div>
              </div>

              <!-- 1) Personal Information -->
              <div class="space-y-4">
                <h3 class="text-lg font-medium text-gray-800 border-b border-gray-200 pb-2">Personal Information</h3>
                
                <!-- Info box explaining auto-synced fields -->
                <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4">
                  <div class="flex">
                    <div class="flex-shrink-0">
                      <svg class="h-5 w-5 text-blue-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                      </svg>
                    </div>
                    <div class="ml-3">
                      <p class="text-sm text-blue-700">
                        <strong>Note:</strong> Some fields below are automatically filled from Step 1 (Front Cover Details) and cannot be edited here. To change these values, go back to Step 1.
                      </p>
                    </div>
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label for="full-legal-name" class="block text-sm font-medium text-gray-600 mb-1">Full Legal Name
                      <span class="text-red-500">*</span>
                      <span class="text-xs text-blue-600 ml-1">(from Step 1)</span>
                    </label>
                    <input type="text" id="full-legal-name" name="personal.fullLegalName"
                      class="w-full p-2 border rounded-lg bg-blue-50 cursor-not-allowed" readonly 
                      data-synced-from="frontCover.fullName"
                      title="This field is synced from Step 1. Go back to Step 1 to edit." /><small class="field-error" role="alert"
                      aria-live="polite"></small>
                  </div>
                  <div>
                    <label for="nicknames" class="block text-sm font-medium text-gray-600 mb-1">Nicknames / Affectionate
                      Names</label>
                    <input type="text" id="nicknames" name="personal.nicknames" class="w-full p-2 border rounded-lg" />
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label for="gender" class="block text-sm font-medium text-gray-600 mb-1">Gender</label>
                    <select id="gender" name="personal.gender" class="w-full p-2 border rounded-lg bg-white">
                      <option value="">Select Gender</option>
                      <option value="Male">Male</option>
                      <option value="Female">Female</option>
                      <option value="Non-Binary">Non-Binary</option>
                      <option value="Other">Other</option>
                    </select>
                  </div>
                  <div>
                    <label for="pronouns" class="block text-sm font-medium text-gray-600 mb-1">Preferred
                      Pronouns</label>
                    <select id="pronouns" name="personal.pronouns" class="w-full p-2 border rounded-lg bg-white">
                      <option value="">Select Pronouns</option>
                      <option value="He/Him">He/Him</option>
                      <option value="She/Her">She/Her</option>
                      <option value="They/Them">They/Them</option>
                      <option value="Custom">Custom</option>
                    </select>
                  </div>
                </div>

                <div id="custom-pronouns-container" class="hidden">
                  <label for="custom-pronouns" class="block text-sm font-medium text-gray-600 mb-1">Custom
                    Pronouns</label>
                  <input type="text" id="custom-pronouns" name="personal.customPronouns"
                    class="w-full p-2 border rounded-lg" placeholder="Enter custom pronouns" />
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label for="date-of-birth" class="block text-sm font-medium text-gray-600 mb-1">Date of Birth <span
                        class="text-red-500">*</span>
                      <span class="text-xs text-blue-600 ml-1">(from Step 1)</span>
                    </label>
                    <input type="date" id="date-of-birth" name="personal.dateOfBirth"
                      class="w-full p-2 border rounded-lg bg-blue-50 cursor-not-allowed" readonly 
                      data-synced-from="frontCover.dob"
                      title="This field is synced from Step 1. Go back to Step 1 to edit." /><small class="field-error" role="alert"
                      aria-live="polite"></small>
                    <p id="birth-date-preview" class="text-sm text-indigo-600 font-medium mt-1 pl-1 h-5"></p>
                  </div>
                  <div>
                    <label for="place-of-birth" class="block text-sm font-medium text-gray-600 mb-1">Place of Birth
                      (City, State)</label>
                    <input type="text" id="place-of-birth" name="personal.placeOfBirth"
                      class="w-full p-2 border rounded-lg" />
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label for="date-of-death" class="block text-sm font-medium text-gray-600 mb-1">Date of
                      Death
                      <span class="text-xs text-blue-600 ml-1">(from Step 1)</span>
                    </label>
                    <input type="date" id="date-of-death" name="personal.dateOfDeath"
                      class="w-full p-2 border rounded-lg bg-blue-50 cursor-not-allowed" readonly 
                      data-synced-from="frontCover.dop"
                      title="This field is synced from Step 1. Go back to Step 1 to edit." /><small class="field-error" role="alert"
                      aria-live="polite"></small>
                    <p id="death-date-preview" class="text-sm text-indigo-600 font-medium mt-1 pl-1 h-5"></p>
                  </div>
                  <div>
                    <label for="place-of-death" class="block text-sm font-medium text-gray-600 mb-1">Place of Death
                      (City, State)</label>
                    <input type="text" id="place-of-death" name="personal.placeOfDeath"
                      class="w-full p-2 border rounded-lg" />
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label for="age-at-passing" class="block text-sm font-medium text-gray-600 mb-1">Age at
                      Passing</label>
                    <input type="text" id="age-at-passing" name="personal.ageAtPassing"
                      class="w-full p-2 border rounded-lg bg-gray-50" readonly />
                  </div>
                </div>
              </div>

              <!-- 2) Faith & Religious Background -->
              <div class="space-y-4">
                <h3 class="text-lg font-medium text-gray-800 border-b border-gray-200 pb-2">Faith & Religious Background
                </h3>

                <div>
                  <label for="religious-affiliation" class="block text-sm font-medium text-gray-600 mb-1">Religious
                    Affiliation / Faith Tradition</label>
                  <select id="religious-affiliation" name="faith.religiousAffiliation"
                    class="w-full p-2 border rounded-lg bg-white">
                    <option value="">Select Faith Tradition</option>
                    <option value="Christian">Christian</option>
                    <option value="Muslim">Muslim</option>
                    <option value="Jewish">Jewish</option>
                    <option value="None">None</option>
                    <option value="Other">Other</option>
                  </select>
                </div>

                <div id="religious-other-container" class="hidden">
                  <label for="religious-other-text" class="block text-sm font-medium text-gray-600 mb-1">Please specify
                    religious affiliation or note if not religious</label>
                  <input type="text" id="religious-other-text" name="faith.religiousAffiliationOther"
                    class="w-full p-2 border rounded-lg" placeholder="Enter details about religious affiliation" />
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-600 mb-2">Church Membership</label>
                  <div id="church-memberships-container" class="space-y-3">
                    <div class="church-entry p-3 border rounded-lg bg-gray-50">
                      <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-3">
                        <input type="text" name="faith.churchMemberships.0.churchName" class="p-2 border rounded-lg"
                          placeholder="Church Name" />
                        <input type="text" name="faith.churchMemberships.0.location" class="p-2 border rounded-lg"
                          placeholder="Location (City, State)" />
                        <input type="text" name="faith.churchMemberships.0.timeframe" class="p-2 border rounded-lg"
                          placeholder="Years/Timeframe" /><small class="field-instructions">Enter years as YYYY–YYYY
                          (e.g., 2004–2011).</small>
                      </div>
                      <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-600 mb-1">Ministry Roles / Service at this
                          Church</label>
                        <textarea name="faith.churchMemberships.0.ministryRoles" rows="2"
                          class="w-full p-2 border rounded-lg"
                          placeholder="Describe ministry roles and service"></textarea>
                      </div>
                      <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-600 mb-2">Baptized here?</label>
                        <div class="flex gap-4">
                          <label class="flex items-center">
                            <input type="radio" name="faith.churchMemberships.0.baptized" value="Yes" class="mr-2" />
                            <span class="text-sm">Yes</span>
                          </label>
                          <label class="flex items-center">
                            <input type="radio" name="faith.churchMemberships.0.baptized" value="No" class="mr-2" />
                            <span class="text-sm">No</span>
                          </label>
                        </div>
                      </div>
                      <div class="baptism-details-0 hidden mb-3 pl-4 border-l-2 border-gray-200">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-2">
                          <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Baptism Date</label>
                            <input type="date" name="faith.churchMemberships.0.baptismDate"
                              class="w-full p-2 border rounded-lg" /><small class="field-error" role="alert"
                              aria-live="polite"></small>
                            <p class="baptism-date-preview-0 text-sm text-indigo-600 font-medium mt-1 pl-1 h-5"></p>
                          </div>
                          <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Baptism Officiant</label>
                            <input type="text" name="faith.churchMemberships.0.baptismOfficiant"
                              class="w-full p-2 border rounded-lg" placeholder="Name of officiant" />
                          </div>
                        </div>
                      </div>
                      <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-600 mb-2">Got saved here?</label>
                        <div class="flex gap-4">
                          <label class="flex items-center">
                            <input type="radio" name="faith.churchMemberships.0.salvation" value="Yes" class="mr-2" />
                            <span class="text-sm">Yes</span>
                          </label>
                          <label class="flex items-center">
                            <input type="radio" name="faith.churchMemberships.0.salvation" value="No" class="mr-2" />
                            <span class="text-sm">No</span>
                          </label>
                        </div>
                      </div>
                      <div class="salvation-details-0 hidden mb-3 pl-4 border-l-2 border-gray-200">
                        <div>
                          <label class="block text-sm font-medium text-gray-600 mb-1">Date/Stage of Salvation</label>
                          <input type="text" name="faith.churchMemberships.0.salvationDate"
                            class="w-full p-2 border rounded-lg" placeholder="Date or stage of salvation" />
                        </div>
                      </div>
                      <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-600 mb-1">Notes / Memories about this
                          Church</label>
                        <textarea name="faith.churchMemberships.0.notes" rows="2" class="w-full p-2 border rounded-lg"
                          placeholder="Optional notes and memories"></textarea>
                      </div>
                      <button type="button"
                        class="remove-church px-3 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 text-sm">Remove
                        Membership</button>
                    </div>
                  </div>
                  <button type="button" id="add-church"
                    class="mt-2 px-4 py-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 text-sm">Add
                    Membership</button>
                </div>
              </div>

            </div>

            <div class="mt-8 flex justify-between">
              <button type="button"
                class="prev-button bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-700">Previous</button>
              <div>
                <button type="button"
                  class="save-progress-button bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">Save</button>
                <button type="button"
                  class="next-button bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700 ml-2">Next</button>
              </div>
            </div>
          </div>

          <!-- Step 3: Education, Career, Hobbies & Personality -->
          <div id="step-3" class="form-step">
            <h2 class="text-xl font-semibold mb-6 text-gray-700 border-b pb-3">Education, Career & Interests</h2>
            
            <div class="space-y-8">

              <!-- 3) Education -->
              <div class="space-y-4">
                <h3 class="text-lg font-medium text-gray-800 border-b border-gray-200 pb-2">Education</h3>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label for="high-school" class="block text-sm font-medium text-gray-600 mb-1">High School
                      Attended</label>
                    <input type="text" id="high-school" name="education.highSchool"
                      class="w-full p-2 border rounded-lg" />
                  </div>
                  <div>
                    <label for="graduation-year" class="block text-sm font-medium text-gray-600 mb-1">Graduation
                      Year</label>
                    <input type="text" id="graduation-year" name="education.graduationYear"
                      class="w-full p-2 border rounded-lg" pattern="^\d{4}$" placeholder="YYYY" />
                  </div>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-600 mb-2">College(s)/University(ies)</label>
                  <div id="colleges-container" class="space-y-3">
                    <div class="college-entry p-3 border rounded-lg bg-gray-50">
                      <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-3">
                        <input type="text" name="education.colleges.0.schoolName" class="p-2 border rounded-lg"
                          placeholder="School Name" />
                        <input type="text" name="education.colleges.0.graduationYear" class="p-2 border rounded-lg"
                          pattern="^\d{4}$" placeholder="Graduation Year (YYYY)" /><small class="field-error"
                          role="alert" aria-live="polite"></small><small class="field-instructions">Enter only the year
                          (YYYY).</small>
                      </div>
                      <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-3">
                        <input type="text" name="education.colleges.0.city" class="p-2 border rounded-lg"
                          placeholder="City" />
                        <input type="text" name="education.colleges.0.state" class="p-2 border rounded-lg"
                          placeholder="State" />
                        <input type="text" name="education.colleges.0.degree" class="p-2 border rounded-lg"
                          placeholder="Degree / Studies Completed" />
                      </div>
                      <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-600 mb-1">Activities / Organizations at this
                          School</label>
                        <textarea name="education.colleges.0.activities" rows="2" class="w-full p-2 border rounded-lg"
                          placeholder="Clubs, fraternities/sororities, sports, leadership, etc."></textarea>
                      </div>
                      <button type="button"
                        class="remove-college px-3 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 text-sm">Remove
                        College/University</button>
                    </div>
                  </div>
                  <button type="button" id="add-college"
                    class="mt-2 px-4 py-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 text-sm">Add
                    College/University</button>
                </div>
              </div>

              <!-- 4) Career -->
              <div class="space-y-4">
                <h3 class="text-lg font-medium text-gray-800 border-b border-gray-200 pb-2">Career</h3>

                <div>
                  <label class="block text-sm font-medium text-gray-600 mb-2">Employers / Occupations</label>
                  <div id="employers-container" class="space-y-3">
                    <div class="employer-entry p-3 border rounded-lg bg-gray-50">
                      <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-2">
                        <input type="text" name="career.employers.0.companyName" class="p-2 border rounded-lg"
                          placeholder="Company Name" />
                        <input type="text" name="career.employers.0.location" class="p-2 border rounded-lg"
                          placeholder="Location" />
                        <input type="text" name="career.employers.0.role" class="p-2 border rounded-lg"
                          placeholder="Role" />
                      </div>
                      <button type="button"
                        class="remove-employer px-3 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 text-sm">Remove
                        Employer</button>
                    </div>
                  </div>
                  <button type="button" id="add-employer"
                    class="mt-2 px-4 py-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 text-sm">Add
                    Employer</button>
                </div>

                <fieldset class="space-y-3">
                  <legend class="text-sm font-medium text-gray-600">Military Service</legend>
                  <div class="flex gap-4">
                    <label class="flex items-center">
                      <input type="radio" name="career.militaryService" value="Yes" class="mr-2" />
                      <span class="text-sm">Yes</span>
                    </label>
                    <label class="flex items-center">
                      <input type="radio" name="career.militaryService" value="No" class="mr-2" checked />
                      <span class="text-sm">No</span>
                    </label>
                  </div>

                  <div id="military-details" class="hidden space-y-3 pl-4 border-l-2 border-gray-200">
                    <div>
                      <label for="military-branch" class="block text-sm font-medium text-gray-600 mb-1">Branch</label>
                      <select id="military-branch" name="career.militaryBranch"
                        class="w-full p-2 border rounded-lg bg-white">
                        <option value="">Select Branch</option>
                        <option value="Army">Army</option>
                        <option value="Navy">Navy</option>
                        <option value="Air Force">Air Force</option>
                        <option value="Marines">Marines</option>
                        <option value="Coast Guard">Coast Guard</option>
                        <option value="National Guard">National Guard</option>
                        <option value="Other">Other</option>
                      </select>
                    </div>
                    <div>
                      <label for="military-rank" class="block text-sm font-medium text-gray-600 mb-1">Rank/Position
                        Held</label>
                      <input type="text" id="military-rank" name="career.militaryRank"
                        class="w-full p-2 border rounded-lg" placeholder="Rank or position held" />
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label for="service-start-year" class="block text-sm font-medium text-gray-600 mb-1">Start
                          Year</label>
                        <input type="text" id="service-start-year" name="career.serviceStartYear"
                          class="w-full p-2 border rounded-lg" pattern="^\d{4}$" placeholder="YYYY" />
                      </div>
                      <div>
                        <label for="service-end-year" class="block text-sm font-medium text-gray-600 mb-1">End
                          Year</label>
                        <input type="text" id="service-end-year" name="career.serviceEndYear"
                          class="w-full p-2 border rounded-lg" pattern="^\d{4}$" placeholder="YYYY" />
                      </div>
                    </div>
                    <div>
                      <label for="military-details-text" class="block text-sm font-medium text-gray-600 mb-1">Additional
                        Details</label>
                      <textarea id="military-details-text" name="career.militaryDetailsText" rows="3"
                        class="w-full p-2 border rounded-lg"
                        placeholder="Optional in-depth information about military service"></textarea>
                    </div>
                  </div>
                </fieldset>
              </div>

              <!-- 5) Hobbies, Passions, and Skills -->
              <div class="space-y-4">
                <h3 class="text-lg font-medium text-gray-800 border-b border-gray-200 pb-2">Hobbies, Passions, and
                  Skills</h3>

                <div>
                  <label class="block text-sm font-medium text-gray-600 mb-2">Hobbies/Passions (select any)</label>
                  <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                    <label class="flex items-center">
                      <input type="checkbox" name="hobbies.passions" value="Poetry" class="mr-2" />
                      <span class="text-sm">Poetry</span>
                    </label>
                    <label class="flex items-center">
                      <input type="checkbox" name="hobbies.passions" value="Singing" class="mr-2" />
                      <span class="text-sm">Singing</span>
                    </label>
                    <label class="flex items-center">
                      <input type="checkbox" name="hobbies.passions" value="Dancing" class="mr-2" />
                      <span class="text-sm">Dancing</span>
                    </label>
                    <label class="flex items-center">
                      <input type="checkbox" name="hobbies.passions" value="Cooking" class="mr-2" />
                      <span class="text-sm">Cooking</span>
                    </label>
                    <label class="flex items-center">
                      <input type="checkbox" name="hobbies.passions" value="Musical Instruments" class="mr-2" />
                      <span class="text-sm">Musical Instruments</span>
                    </label>
                    <label class="flex items-center">
                      <input type="checkbox" name="hobbies.passions" value="Sports" class="mr-2" />
                      <span class="text-sm">Sports</span>
                    </label>
                    <label class="flex items-center">
                      <input type="checkbox" name="hobbies.passions" value="Other" class="mr-2"
                        id="hobbies-other-checkbox" />
                      <span class="text-sm">Other</span>
                    </label>
                  </div>
                  <div id="hobbies-other-container" class="hidden mt-2">
                    <label for="hobbies-other-text" class="block text-sm font-medium text-gray-600 mb-1">Other
                      (describe)</label>
                    <input type="text" id="hobbies-other-text" name="hobbies.passionsOther"
                      class="w-full p-2 border rounded-lg" />
                  </div>
                </div>

                <div>
                  <label for="special-skills" class="block text-sm font-medium text-gray-600 mb-1">Special
                    Skills</label>
                  <input type="text" id="special-skills" name="hobbies.specialSkills"
                    class="w-full p-2 border rounded-lg" />
                </div>
              </div>

              <!-- 6) Personality & Legacy -->
              <div class="space-y-4">
                <h3 class="text-lg font-medium text-gray-800 border-b border-gray-200 pb-2">Personality & Legacy</h3>

                <div>
                  <label class="block text-sm font-medium text-gray-600 mb-2">Known For (select all that apply)</label>
                  <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                    <label class="flex items-center">
                      <input type="checkbox" name="personality.knownFor" value="Humor" class="mr-2" />
                      <span class="text-sm">Humor</span>
                    </label>
                    <label class="flex items-center">
                      <input type="checkbox" name="personality.knownFor" value="Compassion" class="mr-2" />
                      <span class="text-sm">Compassion</span>
                    </label>
                    <label class="flex items-center">
                      <input type="checkbox" name="personality.knownFor" value="Energy" class="mr-2" />
                      <span class="text-sm">Energy</span>
                    </label>
                    <label class="flex items-center">
                      <input type="checkbox" name="personality.knownFor" value="Hospitality" class="mr-2" />
                      <span class="text-sm">Hospitality</span>
                    </label>
                    <label class="flex items-center">
                      <input type="checkbox" name="personality.knownFor" value="Storytelling" class="mr-2" />
                      <span class="text-sm">Storytelling</span>
                    </label>
                    <label class="flex items-center">
                      <input type="checkbox" name="personality.knownFor" value="Other" class="mr-2"
                        id="personality-other-checkbox" />
                      <span class="text-sm">Other</span>
                    </label>
                  </div>
                  <div id="personality-other-container" class="hidden mt-2">
                    <label for="personality-other-text" class="block text-sm font-medium text-gray-600 mb-1">Other
                      (describe)</label>
                    <input type="text" id="personality-other-text" name="personality.knownForOther"
                      class="w-full p-2 border rounded-lg" />
                  </div>
                </div>

                <div>
                  <label for="favorite-sayings" class="block text-sm font-medium text-gray-600 mb-1">Favorite Sayings /
                    Personal Traits</label>
                  <input type="text" id="favorite-sayings" name="personality.favoriteSayings"
                    class="w-full p-2 border rounded-lg" />
                </div>
              </div>

            </div>

            <div class="mt-8 flex justify-between">
              <button type="button"
                class="prev-button bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-700">Previous</button>
              <div>
                <button type="button"
                  class="save-progress-button bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">Save</button>
                <button type="button"
                  class="next-button bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700 ml-2">Next</button>
              </div>
            </div>
          </div>

          <!-- Step 4: Family & Additional Information -->
          <div id="step-4" class="form-step">
            <h2 class="text-xl font-semibold mb-6 text-gray-700 border-b pb-3">Family & Additional Information</h2>
            
            <div class="space-y-8">

              <!-- 1) MOTHER SECTION -->
              <div class="space-y-4 p-4 border rounded-lg bg-blue-50">
                <h3 class="text-lg font-medium text-gray-800 border-b border-gray-200 pb-2">Mother</h3>
                
                <div class="flex gap-4 mb-4">
                  <label class="flex items-center">
                    <input type="radio" name="family.mother.status" value="living" class="mr-2" />
                    <span class="text-sm font-medium">Living</span>
                  </label>
                  <label class="flex items-center">
                    <input type="radio" name="family.mother.status" value="deceased" class="mr-2" checked />
                    <span class="text-sm font-medium">Deceased</span>
                  </label>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label for="mother-first-name" class="block text-sm font-medium text-gray-600 mb-1">First Name</label>
                    <input type="text" id="mother-first-name" name="family.mother.firstName" class="w-full p-2 border rounded-lg" placeholder="Mother's first name" />
                  </div>
                  <div>
                    <label for="mother-last-name" class="block text-sm font-medium text-gray-600 mb-1">Last Name</label>
                    <input type="text" id="mother-last-name" name="family.mother.lastName" class="w-full p-2 border rounded-lg" placeholder="Mother's last name" />
                  </div>
                </div>

                <div>
                  <label for="mother-maiden-name" class="block text-sm font-medium text-gray-600 mb-1">Maiden Name (optional)</label>
                  <input type="text" id="mother-maiden-name" name="family.mother.maidenName" class="w-full p-2 border rounded-lg" placeholder="Mother's maiden name" />
                </div>

                <div>
                  <label for="mother-location" class="block text-sm font-medium text-gray-600 mb-1">Location (City, State) - optional</label>
                  <input type="text" id="mother-location" name="family.mother.location" class="w-full p-2 border rounded-lg" placeholder="e.g., Birmingham, AL" />
                </div>
              </div>

              <!-- 2) FATHER SECTION -->
              <div class="space-y-4 p-4 border rounded-lg bg-green-50">
                <h3 class="text-lg font-medium text-gray-800 border-b border-gray-200 pb-2">Father</h3>
                
                <div class="flex gap-4 mb-4">
                  <label class="flex items-center">
                    <input type="radio" name="family.father.status" value="living" class="mr-2" />
                    <span class="text-sm font-medium">Living</span>
                  </label>
                  <label class="flex items-center">
                    <input type="radio" name="family.father.status" value="deceased" class="mr-2" checked />
                    <span class="text-sm font-medium">Deceased</span>
                  </label>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label for="father-first-name" class="block text-sm font-medium text-gray-600 mb-1">First Name</label>
                    <input type="text" id="father-first-name" name="family.father.firstName" class="w-full p-2 border rounded-lg" placeholder="Father's first name" />
                  </div>
                  <div>
                    <label for="father-last-name" class="block text-sm font-medium text-gray-600 mb-1">Last Name</label>
                    <input type="text" id="father-last-name" name="family.father.lastName" class="w-full p-2 border rounded-lg" placeholder="Father's last name" />
                  </div>
                </div>

                <div>
                  <label for="father-location" class="block text-sm font-medium text-gray-600 mb-1">Location (City, State) - optional</label>
                  <input type="text" id="father-location" name="family.father.location" class="w-full p-2 border rounded-lg" placeholder="e.g., Birmingham, AL" />
                </div>
              </div>

              <!-- 3) MARRIAGE SECTION -->
              <div class="space-y-4 p-4 border rounded-lg bg-pink-50">
                <h3 class="text-lg font-medium text-gray-800 border-b border-gray-200 pb-2">Marriage / Spouse Information</h3>
                
                <p class="text-sm text-gray-600 mb-4">Please provide spouse information regardless of living status. The "Is spouse living?" question determines how they are mentioned in the obituary.</p>

                <!-- Spouse Information - ALWAYS VISIBLE -->
                <div class="space-y-4">
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label for="spouse-first-name-new" class="block text-sm font-medium text-gray-600 mb-1">Spouse's First Name</label>
                      <input type="text" id="spouse-first-name-new" name="family.marriage.spouse.firstName" class="w-full p-2 border rounded-lg bg-white" placeholder="First name" />
                    </div>
                    <div>
                      <label for="spouse-last-name-new" class="block text-sm font-medium text-gray-600 mb-1">Spouse's Last Name</label>
                      <input type="text" id="spouse-last-name-new" name="family.marriage.spouse.lastName" class="w-full p-2 border rounded-lg bg-white" placeholder="Last name" />
                    </div>
                  </div>

                  <div>
                    <label for="marriage-date-new" class="block text-sm font-medium text-gray-600 mb-1">Marriage Date</label>
                    <input type="date" id="marriage-date-new" name="family.marriage.marriageDate" class="w-full p-2 border rounded-lg bg-white" />
                    <p class="text-xs text-gray-500 mt-1">Years married will be auto-calculated</p>
                  </div>

                  <div>
                    <label for="marriage-location-new" class="block text-sm font-medium text-gray-600 mb-1">Where They Were Married (City, State) - optional</label>
                    <input type="text" id="marriage-location-new" name="family.marriage.marriageLocation" class="w-full p-2 border rounded-lg bg-white" placeholder="e.g., Dallas, Texas" />
                  </div>

                  <div>
                    <label for="marriage-details-new" class="block text-sm font-medium text-gray-600 mb-1">Additional Details About Spouse/Marriage</label>
                    <textarea id="marriage-details-new" name="family.marriage.details" rows="3" class="w-full p-2 border rounded-lg bg-white" placeholder="Include any special details about their marriage, spouse, children from union, etc."></textarea>
                  </div>

                  <!-- Is Spouse Living or Deceased -->
                  <div class="border-t pt-4">
                    <label class="block text-sm font-medium text-gray-600 mb-2">Is the spouse living or deceased?</label>
                    <p class="text-xs text-gray-500 mb-3">This determines how the spouse is mentioned in the obituary (survivors vs. preceded in death)</p>
                    <div class="flex gap-4 mb-3">
                      <label class="flex items-center">
                        <input type="radio" name="family.marriage.spouse.status" value="living" class="mr-2" id="spouse-living-new" checked />
                        <span class="text-sm font-medium">Living (mention in survivors)</span>
                      </label>
                      <label class="flex items-center">
                        <input type="radio" name="family.marriage.spouse.status" value="deceased" class="mr-2" id="spouse-deceased-new" />
                        <span class="text-sm font-medium">Deceased (mention in preceded in death)</span>
                      </label>
                    </div>

                    <!-- Spouse Death Date (shown when deceased is selected) -->
                    <div id="spouse-death-date-container-new" class="hidden mt-3 p-3 bg-white rounded-lg border">
                      <label for="spouse-death-date-new" class="block text-sm font-medium text-gray-600 mb-1">Date Spouse Passed Away</label>
                      <input type="date" id="spouse-death-date-new" name="family.marriage.spouse.deathDate" class="w-full p-2 border rounded-lg" />
                    </div>
                  </div>

                  <!-- Auto-calculated Years Married Display -->
                  <div id="years-married-display-new" class="hidden p-3 bg-white border-2 border-green-500 rounded-lg">
                    <p class="text-sm font-medium text-green-700">
                      <span class="font-semibold">Years Married:</span> 
                      <span id="years-married-value-new" class="text-lg">0</span> years
                    </p>
                  </div>
                </div>
              </div>

              <!-- 4) Surviving Family -->
              <div class="space-y-4">
                <h3 class="text-lg font-medium text-gray-800 border-b border-gray-200 pb-2">Surviving Family</h3>

                <div>
                  <label class="block text-sm font-medium text-gray-600 mb-2">Siblings (Living)</label>
                  <p class="text-sm text-gray-500 mb-3">List siblings who are still living</p>
                  <div id="siblings-container" class="space-y-3">
                    <div class="sibling-entry p-3 border rounded-lg bg-gray-50">
                      <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-2">
                        <input type="text" name="surviving.siblings.0.name" class="p-2 border rounded-lg"
                          placeholder="Name" />
                        <select name="surviving.siblings.0.relationshipType" class="p-2 border rounded-lg bg-white">
                          <option value="">Relationship Type</option>
                          <option value="Brother">Brother</option>
                          <option value="Sister">Sister</option>
                        </select>
                      </div>
                      <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-2">
                        <input type="text" name="surviving.siblings.0.location" class="p-2 border rounded-lg"
                          placeholder="Location" />
                        <input type="text" name="surviving.siblings.0.spouse" class="p-2 border rounded-lg"
                          placeholder="Spouse (optional)" />
                      </div>
                      <button type="button"
                        class="remove-sibling px-3 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 text-sm">Remove</button>
                    </div>
                  </div>
                  <button type="button" id="add-sibling"
                    class="mt-2 px-4 py-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 text-sm">Add
                    Sibling</button>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-600 mb-2">Grandparents</label>
                  <div id="grandparents-container" class="space-y-3">
                    <div class="grandparent-entry p-3 border rounded-lg bg-gray-50">
                      <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-2">
                        <input type="text" name="surviving.grandparents.0.name" class="p-2 border rounded-lg"
                          placeholder="Name" />
                        <input type="text" name="surviving.grandparents.0.location" class="p-2 border rounded-lg"
                          placeholder="Location" />
                        <input type="text" name="surviving.grandparents.0.spouse" class="p-2 border rounded-lg"
                          placeholder="Spouse (optional)" />
                      </div>
                      <div class="mb-2">
                        <label class="block text-sm font-medium text-gray-600 mb-1">Status</label>
                        <div class="flex gap-4">
                          <label class="flex items-center">
                            <input type="radio" name="surviving.grandparents.0.status" value="Living" class="mr-2" />
                            <span class="text-sm">Living</span>
                          </label>
                          <label class="flex items-center">
                            <input type="radio" name="surviving.grandparents.0.status" value="Deceased" class="mr-2" />
                            <span class="text-sm">Deceased</span>
                          </label>
                        </div>
                      </div>
                      <button type="button"
                        class="remove-grandparent px-3 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 text-sm">Remove</button>
                    </div>
                  </div>
                  <button type="button" id="add-grandparent"
                    class="mt-2 px-4 py-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 text-sm">Add
                    Grandparent</button>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-600 mb-2">Children (if any)</label>
                  <div id="children-container" class="space-y-3">
                    <div class="child-entry p-3 border rounded-lg bg-gray-50">
                      <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-2">
                        <input type="text" name="surviving.children.0.name" class="p-2 border rounded-lg"
                          placeholder="Name" />
                        <select name="surviving.children.0.relationshipType" class="p-2 border rounded-lg bg-white">
                          <option value="">Relationship Type</option>
                          <option value="Son">Son</option>
                          <option value="Daughter">Daughter</option>
                          <option value="Stepchild">Stepchild</option>
                          <option value="Other">Other</option>
                        </select>
                      </div>
                      <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-2">
                        <input type="text" name="surviving.children.0.location" class="p-2 border rounded-lg"
                          placeholder="Location" />
                        <input type="text" name="surviving.children.0.spouse" class="p-2 border rounded-lg"
                          placeholder="Spouse (optional)" />
                      </div>
                      <button type="button"
                        class="remove-child px-3 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 text-sm">Remove</button>
                    </div>
                  </div>
                  <button type="button" id="add-child"
                    class="mt-2 px-4 py-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 text-sm">Add
                    Child</button>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-600 mb-2">Godparents / Godsiblings</label>
                  <div id="godparents-container" class="space-y-2">
                    <div class="godparent-entry flex gap-2 items-center">
                      <input type="text" name="surviving.godparents.0.name" class="flex-1 p-2 border rounded-lg"
                        placeholder="Name" />
                      <input type="text" name="surviving.godparents.0.description" class="flex-1 p-2 border rounded-lg"
                        placeholder="Optional description" />
                      <button type="button"
                        class="remove-godparent px-3 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 text-sm">Remove</button>
                    </div>
                  </div>
                  <button type="button" id="add-godparent"
                    class="mt-2 px-4 py-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 text-sm">Add
                    Godparent/Godsibling</button>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-600 mb-2">Extended Family (Uncles, Aunts,
                    Cousins)</label>
                  <div id="extended-container" class="space-y-3">
                    <div class="extended-entry p-3 border rounded-lg bg-gray-50">
                      <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-2">
                        <input type="text" name="surviving.extended.0.name" class="p-2 border rounded-lg"
                          placeholder="Name" />
                        <select name="surviving.extended.0.relationship" class="p-2 border rounded-lg bg-white">
                          <option value="">Relationship</option>
                          <option value="Uncle">Uncle</option>
                          <option value="Aunt">Aunt</option>
                          <option value="Cousin">Cousin</option>
                        </select>
                        <input type="text" name="surviving.extended.0.location" class="p-2 border rounded-lg"
                          placeholder="Location" />
                      </div>
                      <button type="button"
                        class="remove-extended px-3 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 text-sm">Remove</button>
                    </div>
                  </div>
                  <button type="button" id="add-extended"
                    class="mt-2 px-4 py-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 text-sm">Add Extended
                    Family</button>
                </div>
              </div>

              <!-- 5) Friends & Special People -->
              <div class="space-y-4">
                <h3 class="text-lg font-medium text-gray-800 border-b border-gray-200 pb-2">Friends & Special People
                </h3>

                <div>
                  <label class="block text-sm font-medium text-gray-600 mb-2">Special Friends</label>
                  <div id="friends-container" class="space-y-3">
                    <div class="friend-entry p-3 border rounded-lg bg-gray-50">
                      <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-2">
                        <input type="text" name="friends.special.0.name" class="p-2 border rounded-lg"
                          placeholder="Name" />
                        <input type="text" name="friends.special.0.description" class="p-2 border rounded-lg"
                          placeholder="Description" />
                      </div>
                      <button type="button"
                        class="remove-friend px-3 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 text-sm">Remove</button>
                    </div>
                  </div>
                  <button type="button" id="add-friend"
                    class="mt-2 px-4 py-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 text-sm">Add Special
                    Friend</button>
                </div>

                <div>
                  <label for="close-classmates" class="block text-sm font-medium text-gray-600 mb-1">Close Classmates /
                    Class Year</label>
                  <input type="text" id="close-classmates" name="friends.classmates"
                    class="w-full p-2 border rounded-lg" />
                </div>

                <div>
                  <label for="special-relationships" class="block text-sm font-medium text-gray-600 mb-1">Other Special
                    Relationships</label>
                  <input type="text" id="special-relationships" name="friends.otherRelationships"
                    class="w-full p-2 border rounded-lg" />
                </div>
              </div>

              <!-- Additional Information -->
              <div class="space-y-4">
                <h3 class="text-lg font-medium text-gray-800 border-b border-gray-200 pb-2">Additional Information</h3>

                <div>
                  <label for="other-information" class="block text-sm font-medium text-gray-600 mb-1">Other Information
                    Not Asked For</label>
                  <textarea id="other-information" name="additional.otherInformation" rows="6"
                    class="w-full p-2 border rounded-lg"
                    placeholder="Include any other information, stories, or details that haven't been covered in the sections above"></textarea>
                  <small class="field-instructions">Use this space to share any additional details not covered in the form.</small>
                </div>
              </div>

              <!-- PRECEDED IN DEATH - MOVED TO BOTTOM -->
              <div class="space-y-4 p-4 border-2 border-yellow-400 rounded-lg bg-yellow-50">
                <h3 class="text-lg font-medium text-gray-800 border-b border-gray-200 pb-2">Preceded in Death By (Other Relatives ONLY)</h3>
                
                <div class="bg-yellow-100 border-l-4 border-yellow-500 p-3 mb-4">
                  <p class="text-sm font-semibold text-yellow-800 mb-2">⚠️ IMPORTANT NOTES:</p>
                  <ul class="text-sm text-yellow-800 space-y-1 ml-4 list-disc">
                    <li><strong>DO NOT include Mother, Father, or Spouse here</strong> - they are already captured above</li>
                    <li>This section is for <strong>OTHER relatives ONLY</strong> (siblings, grandparents, aunts, uncles, etc.)</li>
                    <li>List family members who passed away <strong>before</strong> the deceased</li>
                  </ul>
                </div>

                <div>
                  <div id="preceded-container" class="space-y-3">
                    <div class="preceded-entry p-3 border rounded-lg bg-white">
                      <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-2">
                        <input type="text" name="preceded.0.name" class="p-2 border rounded-lg" placeholder="Name" />
                        <input type="text" name="preceded.0.relationship" class="p-2 border rounded-lg"
                          placeholder="Relationship (e.g., Sister, Brother, Grandparent)" />
                        <input type="text" name="preceded.0.location" class="p-2 border rounded-lg"
                          placeholder="City/State (optional)" />
                      </div>
                      <button type="button"
                        class="remove-preceded px-3 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 text-sm">Remove
                        Person</button>
                    </div>
                  </div>
                  <button type="button" id="add-preceded"
                    class="mt-2 px-4 py-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 text-sm">Add
                    Person</button>
                </div>
              </div>

              <!-- AI Obituary Generation Section -->
              <div class="space-y-4 mt-8 p-6 bg-gradient-to-br from-indigo-50 to-purple-50 rounded-lg border-2 border-indigo-200">
                <div class="flex items-center gap-3 mb-4">
                  <div class="w-10 h-10 bg-indigo-600 rounded-full flex items-center justify-center">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                  </div>
                  <div>
                    <h3 class="text-xl font-semibold text-gray-800">Generate Written Obituary</h3>
                    <p class="text-sm text-gray-600">Let AI create a beautiful obituary based on all the information you've provided</p>
                  </div>
                </div>

                <div class="bg-white p-4 rounded-lg shadow-sm">
                  <p class="text-sm text-gray-600 mb-4">Click the button below to generate a written obituary. You can then review it, make corrections, and regenerate if needed.</p>
                  
                  <button type="button" id="generate-obituary-btn" class="gemini-button w-full bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition-all duration-200 flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    Generate Obituary with AI
                  </button>
                  
                  <!-- Loading State -->
                  <div id="obituary-loading" class="hidden mt-4 text-center">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
                    <p class="text-sm text-gray-600 mt-2">Generating your obituary... This may take a moment.</p>
                  </div>
                  
                  <!-- Error Message -->
                  <div id="obituary-error" class="hidden mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                    <p class="text-sm text-red-800"></p>
                  </div>
                </div>

                <!-- Generated Obituary Preview Section -->
                <div id="obituary-preview-section" class="hidden mt-6">
                  <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex items-center justify-between mb-4">
                      <h4 class="text-lg font-semibold text-gray-800">Generated Obituary Preview</h4>
                      <button type="button" id="preview-obituary-btn" class="bg-blue-100 text-blue-700 font-medium py-2 px-4 rounded-lg hover:bg-blue-200 transition-all duration-200 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                        </svg>
                        View Full Preview
                      </button>
                    </div>
                    
                    <!-- Obituary Text Display -->
                    <div id="obituary-text" class="prose max-w-none p-4 bg-gray-50 rounded border border-gray-200 mb-4" style="font-family: 'Merriweather', serif; line-height: 1.8;">
                      <!-- Generated obituary will appear here -->
                    </div>

                    <!-- Corrections Section -->
                    <div class="mt-4">
                      <label for="obituary-corrections" class="block text-sm font-medium text-gray-700 mb-2">
                        Need Changes? Describe Your Corrections
                      </label>
                      <textarea id="obituary-corrections" rows="4" class="w-full p-3 border rounded-lg"
                        placeholder="Example: 'Please add that she was a member of the choir' or 'Change the wording about her career'"></textarea>
                      <button type="button" id="regenerate-obituary-btn" class="mt-2 bg-purple-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-purple-700 transition-all duration-200">
                        Regenerate with Corrections
                      </button>
                    </div>
                  </div>
                </div>
              </div>

            </div>

            <div class="mt-8 flex justify-between">
              <button type="button"
                class="prev-button bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-700">Previous</button>
              <div>
                <button type="button"
                  class="save-progress-button bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">Save</button>
                <button type="button"
                  class="next-button bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700 ml-2">Next</button>
              </div>
            </div>
          </div>

          <!-- Step 5: Order of Service -->
          <div id="step-5" class="form-step">
            <h2 class="text-xl font-semibold mb-6 text-gray-700 border-b pb-3">Order of Service</h2>
            
            <div class="space-y-6">
              <p class="text-sm text-gray-600 bg-blue-50 p-3 rounded-lg border border-blue-200">
                <strong>Instructions:</strong> Build your order of service by adding items below. You can drag and drop to reorder them. Check the "Additional Info" box to add details like location or notes.
              </p>

              <!-- Order of Service Items Container -->
              <div id="order-of-service-container" class="space-y-3">
                
                <!-- First Item: Processional (Default) -->
                <div class="service-item p-4 border-2 border-gray-300 rounded-lg bg-gray-50" data-index="0" draggable="true">
                  <div class="flex items-center mb-3">
                    <div class="drag-handle cursor-move mr-3 text-gray-400 hover:text-gray-600" title="Drag to reorder">
                      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"></path>
                      </svg>
                    </div>
                    <span class="text-lg font-semibold text-gray-700">Service Item #<span class="item-number">1</span></span>
                  </div>

                  <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                    <div>
                      <label class="block text-sm font-medium text-gray-600 mb-1">Service Item</label>
                      <input type="text" name="orderOfService.0.itemName" class="w-full p-2 border rounded-lg bg-white" placeholder="e.g., Processional" value="Processional" />
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-600 mb-1">Person Performing</label>
                      <input type="text" name="orderOfService.0.personName" class="w-full p-2 border rounded-lg bg-white" placeholder="Enter name" />
                    </div>
                  </div>

                  <div class="mb-3">
                    <label class="flex items-center">
                      <input type="checkbox" class="additional-info-checkbox mr-2" data-index="0" />
                      <span class="text-sm font-medium text-gray-700">Additional Information</span>
                    </label>
                  </div>

                  <!-- Conditional Additional Info Field -->
                  <div class="additional-info-container hidden mt-3">
                    <label class="block text-sm font-medium text-gray-600 mb-1">Additional Details (e.g., location, special notes)</label>
                    <input type="text" name="orderOfService.0.additionalInfo" class="w-full p-2 border rounded-lg bg-white" placeholder="Enter additional details" />
                  </div>

                  <button type="button" class="remove-service-item mt-3 px-3 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 text-sm">
                    Remove Item
                  </button>
                </div>

              </div>

              <!-- Add Service Item Button -->
              <button type="button" id="add-service-item" class="w-full py-3 px-4 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-all duration-200 flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                Add Service Item
              </button>

              <!-- Preview Order of Service -->
              <div class="mt-8 p-4 bg-gradient-to-br from-purple-50 to-indigo-50 rounded-lg border-2 border-purple-200">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">Preview Order of Service</h3>
                <div id="service-preview" class="bg-white p-4 rounded-lg shadow-sm">
                  <ol class="space-y-2" id="preview-list">
                    <!-- Preview items will appear here -->
                  </ol>
                  <p class="text-sm text-gray-500 mt-3 italic">Preview will update as you add items</p>
                </div>
              </div>
            </div>

            <div class="mt-8 flex justify-between">
              <button type="button" class="prev-button bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-700">Previous</button>
              <div>
                <button type="button" class="save-progress-button bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">Save</button>
                <button type="button" class="next-button bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700 ml-2">Next</button>
              </div>
            </div>
          </div>

          <!-- Step 6: Program Back Cover -->
          <div id="step-6" class="form-step">
            <h2 class="text-xl font-semibold mb-6 text-gray-700 border-b pb-3">Program Back Cover</h2>
            
            <div class="space-y-6">
              <div class="bg-blue-50 p-4 rounded-lg border border-blue-200 mb-6">
                <p class="text-sm text-gray-700">
                  <strong>Back Cover Content:</strong> This is the final page of your funeral program. You can add a poem, scripture, acknowledgments, thank you message, or any other content you'd like to include.
                </p>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-600 mb-2">Back Cover Content</label>
                <textarea id="back-cover-content" name="backCover.content" rows="12"
                          class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 bg-white"
                          placeholder="Enter your back cover content here... (poem, scripture, acknowledgments, etc.)"></textarea>
                <p class="text-xs text-gray-500 mt-1">This text will appear on the back page of your program.</p>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-600 mb-2">Upload Image (Optional)</label>
                <input type="file" id="back-cover-image" name="backCover.image" accept="image/*"
                       class="w-full p-3 border border-gray-300 rounded-lg file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" />
                <p class="text-xs text-gray-500 mt-1">Add an optional image for the back cover (e.g., dove, cross, flowers).</p>
              </div>
            </div>

            <div class="mt-8 flex justify-between">
              <button type="button" class="prev-button bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-700">Previous</button>
              <div>
                <button type="button" class="save-progress-button bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">Save</button>
                <button type="button" id="finished-button" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 ml-2">Finished</button>
              </div>
            </div>
          </div>

        </form>

        <!-- Download PDF Section (Hidden until finished) -->
        <div id="download-section" class="hidden mt-8 bg-gradient-to-br from-green-50 to-blue-50 p-8 rounded-xl border-2 border-green-200 text-center">
          <div class="mb-6">
            <svg class="mx-auto h-16 w-16 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
          <h3 class="text-2xl font-bold text-gray-800 mb-3">Your Program is Ready!</h3>
          <p class="text-gray-600 mb-6">Click the button below to download your 4-page funeral program as a PDF.</p>
          <button type="button" id="download-pdf-button" 
                  class="px-8 py-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold text-lg shadow-lg inline-flex items-center gap-2">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            Download PDF
          </button>
        </div>

      </div>
    </div>
    <div id="photo-editor-modal" class="photo-editor-modal hidden">
      <div class="photo-editor-container">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold">Edit Photo</h3>
          <button id="close-editor" class="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
        </div>

        <div class="cropper-container">
          <img id="editor-image" style="max-width: 100%;" />
        </div>

        <div class="editor-controls">
          <button class="editor-btn" data-method="move" title="Move"><span>✋ Move</span></button>
          <button class="editor-btn active" data-method="crop" title="Crop"><span>✂️ Crop</span></button>
          <button class="editor-btn" data-method="zoom" data-option="0.1" title="Zoom In"><span>🔍+ Zoom
              In</span></button>
          <button class="editor-btn" data-method="zoom" data-option="-0.1" title="Zoom Out"><span>🔍- Zoom
              Out</span></button>
          <button class="editor-btn" data-method="rotate" data-option="90" title="Rotate Right"><span>↻
              Rotate</span></button>
          <button class="editor-btn" data-method="rotate" data-option="-90" title="Rotate Left"><span>↺
              Rotate</span></button>
          <button class="editor-btn" data-method="scaleX" data-option="-1" title="Flip Horizontal"><span>↔️ Flip
              H</span></button>
          <button class="editor-btn" data-method="scaleY" data-option="-1" title="Flip Vertical"><span>↕️ Flip
              V</span></button>
          <button class="editor-btn" data-method="reset" title="Reset"><span>🔄 Reset</span></button>
        </div>

        <div class="flex justify-between mt-6">
          <button id="cancel-edit"
            class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button>
          <button id="apply-edit" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Apply
            Changes</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, addDoc, collection, query, where, onSnapshot, getDoc, getDocs, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCenIJ43YuNWi-jdfI01Y2BAZSODaXsIBc",
      authDomain: "obituary-builders-d7576.firebaseapp.com",
      projectId: "obituary-builders-d7576",
      storageBucket: "obituary-builders-d7576.firebasestorage.app",
      messagingSenderId: "1015601969677",
      appId: "1:1015601969677:web:19f55c507413741fbbf344",
      measurementId: "G-95D1G3VMGV"
    };

    const App = {
      auth: null,
      db: null,
      storage: null,
      user: null,
      photoEditor: null,
      currentObituaryId: null,
      currentStep: 1,
      totalSteps: 0,
      obituariesUnsubscribe: null,
      venueSearchTimeout: null,
      viewDisplayModes: new Map(),
      authInitializationTimer: null,
      obituariesCache: new Map(),

      async init() {
        const app = initializeApp(firebaseConfig);
        this.auth = getAuth(app);
        this.db = getFirestore(app);
        this.storage = getStorage(app);

        this.prepareViews();
        await this.loadSiteSettings();

        this.showView('loading-view');
        this.bindUI();
        this.initPhotoEditor();
        this.totalSteps = document.querySelectorAll('.form-step').length;

        onAuthStateChanged(
          this.auth,
          (user) => this.onAuth(user),
          (error) => {
            console.error('Authentication state error:', error);
            this.showView('login-view');
            this.notify('Unable to verify authentication status. Please try again.', 'error');
          }
        );
      },

      async loadSiteSettings() {
        const defaultBgUrl = 'https://images.unsplash.com/photo-1490750967868-88aa4486c946?q=80&w=2070&auto=format&fit=crop';
        try {
          const settingsRef = doc(this.db, 'siteSettings', 'config');
          const docSnap = await getDoc(settingsRef);

          if (docSnap.exists() && docSnap.data().backgroundUrl) {
            document.body.style.backgroundImage = `url('${docSnap.data().backgroundUrl}')`;
          } else {
            console.log("No custom background found, using default.");
            document.body.style.backgroundImage = `url('${defaultBgUrl}')`;
          }
        } catch (error) {
          console.error("Error loading site settings: ", error);
          document.body.style.backgroundImage = `url('${defaultBgUrl}')`;
        }
      },

      async loadFormOptions() {
        try {
          const formOptionsRef = collection(this.db, "formOptions");
          const querySnapshot = await getDocs(formOptionsRef);

          const optionsData = {};
          querySnapshot.forEach(doc => {
            optionsData[doc.id] = doc.data();
          });

          const selectTitleElement = document.querySelector('select[name="frontCover.title"]');
          if (selectTitleElement && optionsData.coverTitles?.titles) {
            selectTitleElement.innerHTML = '<option value="">Select a Title</option>';
            optionsData.coverTitles.titles.forEach(title => {
              const option = document.createElement('option');
              option.value = title;
              option.textContent = title;
              selectTitleElement.appendChild(option);
            });
          }

          const prefixSelect = document.getElementById('prefix-select');
          prefixSelect.innerHTML = '<option value="">Select a Prefix (Optional)</option>';
          const categoryOrder = ['general', 'clergy', 'military', 'politician'];

          categoryOrder.forEach(categoryKey => {
            if (optionsData[categoryKey] && optionsData[categoryKey].titles) {
              const optgroup = document.createElement('optgroup');
              optgroup.label = categoryKey.charAt(0).toUpperCase() + categoryKey.slice(1);
              optionsData[categoryKey].titles.forEach(title => {
                const option = document.createElement('option');
                option.value = title;
                option.textContent = title;
                optgroup.appendChild(option);
              });
              prefixSelect.appendChild(optgroup);
            }
          });

        } catch (error) {
          console.error("Error loading form options: ", error);
          this.notify("Could not load form options from the database.", "error");
        }
      },

      prepareViews() {
        if (!this.viewDisplayModes) {
          this.viewDisplayModes = new Map();
        } else {
          this.viewDisplayModes.clear();
        }

        document.querySelectorAll('.view').forEach(view => {
          const display = this.detectViewDisplayMode(view);
          view.dataset.originalDisplay = display;
          if (view.id) {
            this.viewDisplayModes.set(view.id, display);
          }
          view.hidden = true;
          view.style.display = 'none';
        });
      },

      showView(viewId) {
        let targetView = null;
        document.querySelectorAll('.view').forEach(view => {
          const isTarget = view.id === viewId;
          if (isTarget) {
            const display = this.viewDisplayModes.get(viewId) || this.detectViewDisplayMode(view);
            this.viewDisplayModes.set(viewId, display);
            view.hidden = false;
            view.style.display = display;
            targetView = view;
          } else {
            view.hidden = true;
            view.style.display = 'none';
          }
        });

        if (viewId === 'loading-view') {
          this.scheduleAuthFallback();
        } else {
          this.clearAuthFallback();
        }

        if (targetView) {
          const scrollToTop = () => {
            if (typeof window.scrollTo === 'function') {
              try {
                window.scrollTo({ top: 0, behavior: 'auto' });
              } catch (error) {
                window.scrollTo(0, 0);
              }
            }
          };

          if (typeof window.requestAnimationFrame === 'function') {
            window.requestAnimationFrame(scrollToTop);
          } else {
            scrollToTop();
          }
        }
      },

      detectViewDisplayMode(view) {
        if (!view) return 'block';
        if (view.dataset.originalDisplay) return view.dataset.originalDisplay;
        if (view.classList.contains('inline-flex')) return 'inline-flex';
        if (view.classList.contains('flex')) return 'flex';
        if (view.classList.contains('inline-grid')) return 'inline-grid';
        if (view.classList.contains('grid')) return 'grid';
        if (view.classList.contains('inline-block')) return 'inline-block';
        if (view.classList.contains('inline')) return 'inline';
        return 'block';
      },

      scheduleAuthFallback() {
        this.clearAuthFallback();
        this.authInitializationTimer = setTimeout(() => {
          this.authInitializationTimer = null;
          if (!this.user) {
            this.showView('login-view');
          }
        }, 4000);
      },

      clearAuthFallback() {
        if (this.authInitializationTimer) {
          clearTimeout(this.authInitializationTimer);
          this.authInitializationTimer = null;
        }
      },

      onAuth(user) {
        this.clearAuthFallback();
        if (this.obituariesUnsubscribe) {
          this.obituariesUnsubscribe();
        }
        this.user = user;

        if (user) {
          this.showView('dashboard-view');
          document.getElementById('user-name').textContent = user.email;
          this.loadUserObituaries();
          this.loadFormOptions();
        } else {
          this.showView('login-view');
        }
      },

      loadUserObituaries() {
        if (!this.user) return;
        const obituariesRef = collection(this.db, `users/${this.user.uid}/obituaries`);
        const q = query(obituariesRef);

        this.obituariesUnsubscribe = onSnapshot(q, (snapshot) => {
          this.renderObituariesList(snapshot.docs);
        }, (error) => {
          console.error("Error loading obituaries:", error);
          this.notify("Could not load programs. Please check Firestore rules.", "error");
        });
      },

      renderObituariesList(docs) {
        const container = document.getElementById('obituaries-list-container');
        const noObituariesView = document.getElementById('no-obituaries-view');
        container.innerHTML = '';
        if (this.obituariesCache) {
          this.obituariesCache.clear();
        }

        if (docs.length === 0) {
          noObituariesView.style.display = 'block';
        } else {
          noObituariesView.style.display = 'none';
          const grid = document.createElement('div');
          grid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
          docs.forEach(doc => {
            const data = doc.data();
            if (this.obituariesCache) {
              this.obituariesCache.set(doc.id, data);
            }
            const deceasedName = data.frontCover?.fullName || 'Untitled Program';
            const photoUrl = data.frontCover?.photoUrl;
            const item = document.createElement('div');
            item.className = 'bg-gray-50 border rounded-xl p-4 shadow-sm hover:shadow-md transition-shadow flex items-center';

            const photoPlaceholder = `
                    <div class="flex-shrink-0 h-16 w-16 bg-gray-200 rounded-lg flex items-center justify-center mr-4">
                        <svg class="h-8 w-8 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    </div>
                  `;

            const photoElement = photoUrl ?
              `<img src="${photoUrl}" alt="${deceasedName}" class="flex-shrink-0 h-16 w-16 rounded-lg object-cover mr-4">` :
              photoPlaceholder;

            item.innerHTML = `
                      ${photoElement}
                      <div class="flex-grow">
                        <h3 class="text-lg font-serif font-bold text-gray-800 truncate">${deceasedName}</h3>
                        <p class="text-sm text-gray-500 mb-2">Last updated: ${data.updatedAt ? new Date(data.updatedAt.seconds * 1000).toLocaleDateString() : 'N/A'}</p>
                        <div class="flex items-center gap-2">
                            <button data-id="${doc.id}" class="edit-btn w-full bg-indigo-100 text-indigo-700 font-semibold py-2 px-4 rounded-lg hover:bg-indigo-200 text-sm">Edit</button>
                            <button data-id="${doc.id}" class="delete-btn w-full bg-red-100 text-red-700 font-semibold py-2 px-4 rounded-lg hover:bg-red-200 text-sm">Delete</button>
                        </div>
                      </div>
                  `;
            grid.appendChild(item);
          });
          container.appendChild(grid);

          container.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', (e) => this.handleEdit(e.currentTarget.dataset.id)));
          container.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => this.handleDelete(e.currentTarget)));
        }
      },

      bindUI() {
        this.bindAuthenticationForms();
        this.bindPhotoUpload();
        this.bindDashboard();
        this.bindFormNavigation();
        this.bindVenueAutocomplete();
        this.bindVenueTypeOther();
        this.bindEulogistLogic();
        this.bindFormattingHandlers();
        this.setupObituaryGeneration();
        this.initOrderOfService();
      },

      bindFormattingHandlers() {
        const handler = () => this.updateAllFormattedDisplays();
        document.querySelectorAll('input[data-format-target]').forEach(el => {
          el.addEventListener('input', handler);
          el.addEventListener('change', handler);
        });

        // Date preview and age calculation for Life Story Information form
        this.bindLifeStoryDateHandlers();
        this.bindConditionalFields();
        this.bindRepeatableGroups();
        
        // Bind Step 1 fields to sync to Step 2
        this.bindStep1FieldsForSync();
      },

      bindLifeStoryDateHandlers() {
        const birthDate = document.getElementById('date-of-birth');
        const deathDate = document.getElementById('date-of-death');
        const birthPreview = document.getElementById('birth-date-preview');
        const deathPreview = document.getElementById('death-date-preview');
        const ageField = document.getElementById('age-at-passing');

        const updatePreviews = () => {
          if (birthDate && birthPreview) {
            birthPreview.textContent = this.formatDate(birthDate.value);
          }
          if (deathDate && deathPreview) {
            deathPreview.textContent = this.formatDate(deathDate.value);
          }

          // Calculate age when both dates are present
          if (birthDate && deathDate && ageField && birthDate.value && deathDate.value) {
            const age = this.calculateAge(birthDate.value, deathDate.value);
            ageField.value = age !== null ? age.toString() : '';
          } else if (ageField) {
            ageField.value = '';
          }
        };

        if (birthDate) {
          birthDate.addEventListener('input', updatePreviews);
          birthDate.addEventListener('change', updatePreviews);
        }
        if (deathDate) {
          deathDate.addEventListener('input', updatePreviews);
          deathDate.addEventListener('change', updatePreviews);
        }
      },
      
      syncStep1ToStep2() {
        // Define the field mappings from Step 1 to Step 2
        const syncMappings = {
          'frontCover.fullName': 'personal.fullLegalName',
          'frontCover.dob': 'personal.dateOfBirth',
          'frontCover.dop': 'personal.dateOfDeath'
        };
        
        // Sync each mapped field
        Object.entries(syncMappings).forEach(([sourceField, targetField]) => {
          const sourceInput = document.querySelector(`[name="${sourceField}"]`);
          const targetInput = document.querySelector(`[name="${targetField}"]`);
          
          if (sourceInput && targetInput) {
            targetInput.value = sourceInput.value;
            
            // Trigger events for date fields to update previews
            if (targetInput.type === 'date') {
              const birthPreview = document.getElementById('birth-date-preview');
              const deathPreview = document.getElementById('death-date-preview');
              
              if (targetField === 'personal.dateOfBirth' && birthPreview) {
                birthPreview.textContent = this.formatDate(targetInput.value);
              }
              if (targetField === 'personal.dateOfDeath' && deathPreview) {
                deathPreview.textContent = this.formatDate(targetInput.value);
              }
            }
          }
        });
        
        // Also recalculate age in Step 2
        const birthDateStep2 = document.querySelector('input[name="personal.dateOfBirth"]');
        const deathDateStep2 = document.querySelector('input[name="personal.dateOfDeath"]');
        const ageField = document.getElementById('age-at-passing');
        
        if (birthDateStep2 && deathDateStep2 && ageField && birthDateStep2.value && deathDateStep2.value) {
          const age = this.calculateAge(birthDateStep2.value, deathDateStep2.value);
          ageField.value = age !== null ? age.toString() : '';
        }
      },
      
      bindStep1FieldsForSync() {
        // Bind Step 1 fields to sync to Step 2 when they change
        const fullNameStep1 = document.querySelector('input[name="frontCover.fullName"]');
        const dobStep1 = document.querySelector('input[name="frontCover.dob"]');
        const dopStep1 = document.querySelector('input[name="frontCover.dop"]');
        
        [fullNameStep1, dobStep1, dopStep1].forEach(field => {
          if (field) {
            field.addEventListener('input', () => this.syncStep1ToStep2());
            field.addEventListener('change', () => this.syncStep1ToStep2());
          }
        });
      },

      bindConditionalFields() {
        // Marriage Status Toggle
        const marriageYes = document.getElementById('marriage-yes');
        const marriageNo = document.getElementById('marriage-no');
        const marriageDetailsContainer = document.getElementById('marriage-details-container');
        
        if (marriageYes && marriageNo && marriageDetailsContainer) {
          marriageYes.addEventListener('change', (e) => {
            if (e.target.checked) {
              marriageDetailsContainer.classList.remove('hidden');
            }
          });
          marriageNo.addEventListener('change', (e) => {
            if (e.target.checked) {
              marriageDetailsContainer.classList.add('hidden');
            }
          });
        }

        // Spouse Deceased Toggle
        const spouseDeceasedCheckbox = document.getElementById('spouse-deceased');
        const spouseDeathDetails = document.getElementById('spouse-death-details');
        
        if (spouseDeceasedCheckbox && spouseDeathDetails) {
          spouseDeceasedCheckbox.addEventListener('change', (e) => {
            if (e.target.checked) {
              spouseDeathDetails.classList.remove('hidden');
            } else {
              spouseDeathDetails.classList.add('hidden');
            }
          });
        }

        // Custom Pronouns
        const pronounsSelect = document.getElementById('pronouns');
        const customContainer = document.getElementById('custom-pronouns-container');
        if (pronounsSelect && customContainer) {
          pronounsSelect.addEventListener('change', (e) => {
            if (e.target.value === 'Custom') {
              customContainer.classList.remove('hidden');
            } else {
              customContainer.classList.add('hidden');
            }
          });
        }

        // Religious Affiliation Other
        const religiousSelect = document.getElementById('religious-affiliation');
        const religiousOtherContainer = document.getElementById('religious-other-container');
        if (religiousSelect && religiousOtherContainer) {
          religiousSelect.addEventListener('change', (e) => {
            if (e.target.value === 'Other') {
              religiousOtherContainer.classList.remove('hidden');
            } else {
              religiousOtherContainer.classList.add('hidden');
            }
          });
        }

        // Military Service
        const militaryRadios = document.querySelectorAll('input[name="career.militaryService"]');
        const militaryDetails = document.getElementById('military-details');
        if (militaryDetails) {
          militaryRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
              if (e.target.value === 'Yes') {
                militaryDetails.classList.remove('hidden');
              } else {
                militaryDetails.classList.add('hidden');
              }
            });
          });
        }

        // Hobbies Other
        const hobbiesOtherCheckbox = document.getElementById('hobbies-other-checkbox');
        const hobbiesOtherContainer = document.getElementById('hobbies-other-container');
        if (hobbiesOtherCheckbox && hobbiesOtherContainer) {
          hobbiesOtherCheckbox.addEventListener('change', (e) => {
            if (e.target.checked) {
              hobbiesOtherContainer.classList.remove('hidden');
            } else {
              hobbiesOtherContainer.classList.add('hidden');
            }
          });
        }

        // Personality Other
        const personalityOtherCheckbox = document.getElementById('personality-other-checkbox');
        const personalityOtherContainer = document.getElementById('personality-other-container');
        if (personalityOtherCheckbox && personalityOtherContainer) {
          personalityOtherCheckbox.addEventListener('change', (e) => {
            if (e.target.checked) {
              personalityOtherContainer.classList.remove('hidden');
            } else {
              personalityOtherContainer.classList.add('hidden');
            }
          });
        }
      },

      bindRepeatableGroups() {
        // Church Memberships
        this.setupRepeatableGroup('church-memberships', 'church', (index) =>
          `<div class="church-entry p-3 border rounded-lg bg-gray-50"> <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-3"> <input type="text" name="faith.churchMemberships.${index}.churchName" class="p-2 border rounded-lg" placeholder="Church Name" /> <input type="text" name="faith.churchMemberships.${index}.location" class="p-2 border rounded-lg" placeholder="Location (City, State)" /> <input type="text" name="faith.churchMemberships.${index}.timeframe" class="p-2 border rounded-lg" placeholder="Years/Timeframe" /> </div> <div class="mb-3"> <label class="block text-sm font-medium text-gray-600 mb-1">Ministry Roles / Service at this Church</label> <textarea name="faith.churchMemberships.${index}.ministryRoles" rows="2" class="w-full p-2 border rounded-lg" placeholder="Describe ministry roles and service"></textarea> </div> <div class="mb-3"> <label class="block text-sm font-medium text-gray-600 mb-2">Baptized here?</label> <div class="flex gap-4"> <label class="flex items-center"> <input type="radio" name="faith.churchMemberships.${index}.baptized" value="Yes" class="mr-2" /> <span class="text-sm">Yes</span> </label> <label class="flex items-center"> <input type="radio" name="faith.churchMemberships.${index}.baptized" value="No" class="mr-2" /> <span class="text-sm">No</span> </label> </div> </div><small class="field-instructions">Select Yes or No. If Yes, provide baptism details or salvation story.</small> <div class="mb-3"> <label class="block text-sm font-medium text-gray-600 mb-2">Got saved here?</label> <div class="flex gap-4"> <label class="flex items-center"> <input type="radio" name="faith.churchMemberships.${index}.salvation" value="Yes" class="mr-2" /> <span class="text-sm">Yes</span> </label> <label class="flex items-center"> <input type="radio" name="faith.churchMemberships.${index}.salvation" value="No" class="mr-2" /> <span class="text-sm">No</span> </label> </div> </div> <div class="mb-3"> <label class="block text-sm font-medium text-gray-600 mb-1">Notes / Memories about this Church</label> <textarea name="faith.churchMemberships.${index}.notes" rows="2" class="w-full p-2 border rounded-lg" placeholder="Optional notes and memories"></textarea> </div> <button type="button" class="remove-church px-3 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 text-sm">Remove Membership</button> </div>`);

        // Colleges (updated)
        this.setupRepeatableGroup('colleges', 'college', (index) =>
          `<div class="college-entry p-3 border rounded-lg bg-gray-50"> <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-3"> <input type="text" name="education.colleges.${index}.schoolName" class="p-2 border rounded-lg" placeholder="School Name" /> <input type="text" name="education.colleges.${index}.graduationYear" class="p-2 border rounded-lg" pattern="^\\d{4}$" placeholder="Graduation Year (YYYY)" /> </div> <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-3"> <input type="text" name="education.colleges.${index}.city" class="p-2 border rounded-lg" placeholder="City" /> <input type="text" name="education.colleges.${index}.state" class="p-2 border rounded-lg" placeholder="State" /> <input type="text" name="education.colleges.${index}.degree" class="p-2 border rounded-lg" placeholder="Degree / Studies Completed" /> </div> <div class="mb-3"> <label class="block text-sm font-medium text-gray-600 mb-1">Activities / Organizations at this School</label> <textarea name="education.colleges.${index}.activities" rows="2" class="w-full p-2 border rounded-lg" placeholder="Clubs, teams, organizations, leadership, etc."></textarea> </div> <button type="button" class="remove-college px-3 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 text-sm">Remove College/University</button> </div>`);

        // Employers
        this.setupRepeatableGroup('employers', 'employer', (index) =>
          `<div class="employer-entry p-3 border rounded-lg bg-gray-50">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-2">
              <input type="text" name="career.employers.${index}.companyName" class="p-2 border rounded-lg" placeholder="Company Name" />
              <input type="text" name="career.employers.${index}.location" class="p-2 border rounded-lg" placeholder="Location" />
              <input type="text" name="career.employers.${index}.role" class="p-2 border rounded-lg" placeholder="Role" />
            </div>
            <button type="button" class="remove-employer px-3 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 text-sm">Remove Employer</button>
          </div>`);

        // Preceded in Death
        this.setupRepeatableGroup('preceded', 'preceded', (index) =>
          `<div class="preceded-entry p-3 border rounded-lg bg-gray-50">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-2">
              <input type="text" name="preceded.${index}.name" class="p-2 border rounded-lg" placeholder="Name" />
              <input type="text" name="preceded.${index}.relationship" class="p-2 border rounded-lg" placeholder="Relationship" />
              <input type="text" name="preceded.${index}.location" class="p-2 border rounded-lg" placeholder="City/State (optional)" />
            </div>
            <button type="button" class="remove-preceded px-3 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 text-sm">Remove Person</button>
          </div>`);

        // Parents (updated)
        this.setupRepeatableGroup('parents', 'parent', (index) =>
          `<div class="parent-entry p-3 border rounded-lg bg-gray-50">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-2">
              <select name="surviving.parents.${index}.relationship" class="p-2 border rounded-lg bg-white">
                <option value="">Relationship</option>
                <option value="Mother">Mother</option>
                <option value="Father">Father</option>
              </select>
              <input type="text" name="surviving.parents.${index}.name" class="p-2 border rounded-lg" placeholder="Name" />
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-2">
              <input type="text" name="surviving.parents.${index}.location" class="p-2 border rounded-lg" placeholder="Location" />
              <input type="text" name="surviving.parents.${index}.spouse" class="p-2 border rounded-lg" placeholder="Spouse (optional)" />
            </div>
            <div class="mb-2">
              <label class="flex items-center">
                <input type="checkbox" name="surviving.parents.${index}.deceased" class="mr-2" />
                <span class="text-sm">Deceased</span>
              </label>
            </div>
            <button type="button" class="remove-parent px-3 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 text-sm">Remove</button>
          </div>`);

        // Siblings
        this.setupRepeatableGroup('siblings', 'sibling', (index) =>
          `<div class="sibling-entry p-3 border rounded-lg bg-gray-50">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-2">
              <input type="text" name="surviving.siblings.${index}.name" class="p-2 border rounded-lg" placeholder="Name" />
              <select name="surviving.siblings.${index}.relationshipType" class="p-2 border rounded-lg bg-white">
                <option value="">Relationship Type</option>
                <option value="Brother">Brother</option>
                <option value="Sister">Sister</option>
              </select>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-2">
              <input type="text" name="surviving.siblings.${index}.location" class="p-2 border rounded-lg" placeholder="Location" />
              <input type="text" name="surviving.siblings.${index}.spouse" class="p-2 border rounded-lg" placeholder="Spouse (optional)" />
            </div>
            <button type="button" class="remove-sibling px-3 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 text-sm">Remove</button>
          </div>`);

        // Grandparents (updated)
        this.setupRepeatableGroup('grandparents', 'grandparent', (index) =>
          `<div class="grandparent-entry p-3 border rounded-lg bg-gray-50">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-2">
              <input type="text" name="surviving.grandparents.${index}.name" class="p-2 border rounded-lg" placeholder="Name" />
              <input type="text" name="surviving.grandparents.${index}.location" class="p-2 border rounded-lg" placeholder="Location" />
              <input type="text" name="surviving.grandparents.${index}.spouse" class="p-2 border rounded-lg" placeholder="Spouse (optional)" />
            </div>
            <div class="mb-2">
              <label class="block text-sm font-medium text-gray-600 mb-1">Status</label>
              <div class="flex gap-4">
                <label class="flex items-center">
                  <input type="radio" name="surviving.grandparents.${index}.status" value="Living" class="mr-2" />
                  <span class="text-sm">Living</span>
                </label>
                <label class="flex items-center">
                  <input type="radio" name="surviving.grandparents.${index}.status" value="Deceased" class="mr-2" />
                  <span class="text-sm">Deceased</span>
                </label>
              </div>
            </div>
            <button type="button" class="remove-grandparent px-3 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 text-sm">Remove</button>
          </div>`);

        // Children (updated)
        this.setupRepeatableGroup('children', 'child', (index) =>
          `<div class="child-entry p-3 border rounded-lg bg-gray-50">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-2">
              <input type="text" name="surviving.children.${index}.name" class="p-2 border rounded-lg" placeholder="Name" />
              <select name="surviving.children.${index}.relationshipType" class="p-2 border rounded-lg bg-white">
                <option value="">Relationship Type</option>
                <option value="Son">Son</option>
                <option value="Daughter">Daughter</option>
                <option value="Stepchild">Stepchild</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-2">
              <input type="text" name="surviving.children.${index}.location" class="p-2 border rounded-lg" placeholder="Location" />
              <input type="text" name="surviving.children.${index}.spouse" class="p-2 border rounded-lg" placeholder="Spouse (optional)" />
            </div>
            <button type="button" class="remove-child px-3 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 text-sm">Remove</button>
          </div>`);

        // Godparents
        this.setupRepeatableGroup('godparents', 'godparent', (index) =>
          `<div class="godparent-entry flex gap-2 items-center">
            <input type="text" name="surviving.godparents.${index}.name" class="flex-1 p-2 border rounded-lg" placeholder="Name" />
            <input type="text" name="surviving.godparents.${index}.description" class="flex-1 p-2 border rounded-lg" placeholder="Optional description" />
            <button type="button" class="remove-godparent px-3 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 text-sm">Remove</button>
          </div>`);

        // Extended Family
        this.setupRepeatableGroup('extended', 'extended', (index) =>
          `<div class="extended-entry p-3 border rounded-lg bg-gray-50">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-2">
              <input type="text" name="surviving.extended.${index}.name" class="p-2 border rounded-lg" placeholder="Name" />
              <select name="surviving.extended.${index}.relationship" class="p-2 border rounded-lg bg-white">
                <option value="">Relationship</option>
                <option value="Uncle">Uncle</option>
                <option value="Aunt">Aunt</option>
                <option value="Cousin">Cousin</option>
              </select>
              <input type="text" name="surviving.extended.${index}.location" class="p-2 border rounded-lg" placeholder="Location" />
            </div>
            <button type="button" class="remove-extended px-3 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 text-sm">Remove</button>
          </div>`);

        // Special Friends
        this.setupRepeatableGroup('friends', 'friend', (index) =>
          `<div class="friend-entry p-3 border rounded-lg bg-gray-50">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-2">
              <input type="text" name="friends.special.${index}.name" class="p-2 border rounded-lg" placeholder="Name" />
              <input type="text" name="friends.special.${index}.description" class="p-2 border rounded-lg" placeholder="Description" />
            </div>
            <button type="button" class="remove-friend px-3 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 text-sm">Remove</button>
          </div>`);
      },

      setupRepeatableGroup(groupName, itemName, templateFn) {
        const addBtn = document.getElementById(`add-${itemName}`);
        const container = document.getElementById(`${groupName}-container`);

        if (!addBtn || !container) return;

        let counter = container.querySelectorAll(`.${itemName}-entry`).length;

        // Add button handler
        addBtn.addEventListener('click', () => {
          const newEntry = document.createElement('div');
          newEntry.innerHTML = templateFn(counter);
          const entryElement = newEntry.firstElementChild;

          // Add remove handler
          const removeBtn = entryElement.querySelector(`.remove-${itemName}`);
          if (removeBtn) {
            removeBtn.addEventListener('click', () => {
              entryElement.remove();
            });
          }

          container.appendChild(entryElement);
          counter++;
        });

        // Existing remove button handlers
        container.querySelectorAll(`.remove-${itemName}`).forEach(btn => {
          btn.addEventListener('click', (e) => {
            const entry = e.target.closest(`.${itemName}-entry`);
            if (entry) entry.remove();
          });
        });
      },

      bindEulogistLogic() {
        const eulogistRadios = document.querySelectorAll('input[name="eulogistSame"]');
        const eulogistContainer = document.getElementById('eulogist-input-container');
        const eulogistInput = document.getElementById('eulogist');
        const eulogistLabel = eulogistContainer.querySelector('label');

        const updateEulogistRequirement = (isEulogistDifferent) => {
          if (isEulogistDifferent) {
            eulogistContainer.classList.remove('hidden');
            eulogistInput.required = true;
            if (!eulogistLabel.querySelector('.text-red-500')) {
              eulogistLabel.insertAdjacentHTML('beforeend', ' <span class="text-red-500">*</span>');
            }
          } else {
            eulogistContainer.classList.add('hidden');
            eulogistInput.required = false;
            eulogistInput.value = '';
            eulogistInput.classList.remove('error-border');
            const asterisk = eulogistLabel.querySelector('.text-red-500');
            if (asterisk) {
              asterisk.remove();
            }
          }
        };

        eulogistRadios.forEach(radio => {
          radio.addEventListener('change', (e) => {
            updateEulogistRequirement(e.target.value === 'no');
          });
        });
      },

      bindVenueTypeOther() {
        const venueTypeSelect = document.querySelector('select[name="frontCover.venue.type"]');
        const otherContainer = document.getElementById('other-venue-type-container');
        const otherInput = document.querySelector('input[name="frontCover.venue.otherType"]');

        venueTypeSelect.addEventListener('change', (e) => {
          if (e.target.value === 'Other') {
            otherContainer.classList.remove('hidden');
            otherInput.required = true;
          } else {
            otherContainer.classList.add('hidden');
            otherInput.required = false;
            otherInput.value = '';
          }
        });
      },

      bindVenueAutocomplete() {
        const venueNameInput = document.querySelector('input[name="frontCover.venue.name"]');
        const suggestionsContainer = document.getElementById('venue-suggestions');

        venueNameInput.addEventListener('input', () => {
          clearTimeout(this.venueSearchTimeout);
          const queryText = venueNameInput.value.trim();
          if (queryText.length < 3) {
            suggestionsContainer.innerHTML = '';
            suggestionsContainer.classList.add('hidden');
            return;
          }
          this.venueSearchTimeout = setTimeout(async () => {
            const venuesRef = collection(this.db, "venues");
            const q = query(venuesRef, where("name", ">=", queryText), where("name", "<=", queryText + '\uf8ff'));
            const querySnapshot = await getDocs(q);

            suggestionsContainer.innerHTML = '';
            if (querySnapshot.empty) {
              suggestionsContainer.classList.add('hidden');
            } else {
              suggestionsContainer.classList.remove('hidden');
              querySnapshot.forEach(doc => {
                const venue = doc.data();
                const suggestionEl = document.createElement('div');
                suggestionEl.textContent = `${venue.name} - ${venue.city}, ${venue.state}`;
                suggestionEl.addEventListener('click', () => {
                  this.populateVenue(venue);
                  suggestionsContainer.classList.add('hidden');
                });
                suggestionsContainer.appendChild(suggestionEl);
              });
            }
          }, 300);
        });
      },

      populateVenue(venue) {
        document.querySelector('input[name="frontCover.venue.name"]').value = venue.name || '';
        document.querySelector('input[name="frontCover.venue.street"]').value = venue.street || '';
        document.querySelector('input[name="frontCover.venue.city"]').value = venue.city || '';
        document.querySelector('input[name="frontCover.venue.state"]').value = venue.state || '';
        document.querySelector('input[name="frontCover.venue.zip"]').value = venue.zip || '';

        const venueTypeSelect = document.querySelector('select[name="frontCover.venue.type"]');
        const otherContainer = document.getElementById('other-venue-type-container');
        const otherInput = document.querySelector('input[name="frontCover.venue.otherType"]');

        const options = Array.from(venueTypeSelect.options).map(o => o.value);
        if (venue.type && options.includes(venue.type)) {
          venueTypeSelect.value = venue.type;
          otherContainer.classList.add('hidden');
          otherInput.required = false;
          otherInput.value = '';
        } else if (venue.type) {
          venueTypeSelect.value = 'Other';
          otherContainer.classList.remove('hidden');
          otherInput.required = true;
          otherInput.value = venue.type;
        } else {
          venueTypeSelect.value = '';
          otherContainer.classList.add('hidden');
          otherInput.required = false;
          otherInput.value = '';
        }
      },

      bindAuthenticationForms() {
        document.getElementById('login-form')?.addEventListener('submit', (e) => { e.preventDefault(); this.handleLogin(); });
        document.getElementById('signup-form')?.addEventListener('submit', (e) => { e.preventDefault(); this.handleSignup(); });
        document.getElementById('show-signup')?.addEventListener('click', (e) => { e.preventDefault(); this.showView('signup-view'); });
        document.getElementById('show-login')?.addEventListener('click', (e) => { e.preventDefault(); this.showView('login-view'); });
        document.getElementById('logout-button')?.addEventListener('click', () => this.handleLogout());
      },

      async handleLogin() {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const errorDiv = document.getElementById('login-error');
        try {
          this.showView('loading-view');
          await signInWithEmailAndPassword(this.auth, email, password);
        } catch (error) {
          this.showView('login-view');
          this.showError(errorDiv, this.getErrorMessage(error.code));
        }
      },

      async handleSignup() {
        const email = document.getElementById('signup-email').value;
        const password = document.getElementById('signup-password').value;
        const firstName = document.getElementById('signup-firstname').value;
        const lastName = document.getElementById('signup-lastname').value;
        const errorDiv = document.getElementById('signup-error');
        const termsCheckbox = document.getElementById('signup-terms');

        if (!termsCheckbox.checked) {
          this.showError(errorDiv, "You must agree to the Terms of Service to create an account.");
          return;
        }

        try {
          this.showView('loading-view');
          const userCredential = await createUserWithEmailAndPassword(this.auth, email, password);
          await setDoc(doc(this.db, 'users', userCredential.user.uid), {
            firstName, lastName, email,
            street: document.getElementById('signup-street').value,
            city: document.getElementById('signup-city').value,
            state: document.getElementById('signup-state').value,
            zip: document.getElementById('signup-zip').value,
            phone: document.getElementById('signup-phone').value,
            createdAt: serverTimestamp()
          });
        } catch (error) {
          this.showView('signup-view');
          this.showError(errorDiv, this.getErrorMessage(error.code));
        }
      },

      async handleLogout() {
        try {
          await signOut(this.auth);
        } catch (error) {
          this.notify('Error logging out.', 'error');
        }
      },

      bindDashboard() {
        document.getElementById('create-new-button')?.addEventListener('click', () => this.handleCreateNew());
        document.getElementById('form-back-to-dashboard')?.addEventListener('click', () => {
          this.showView('dashboard-view');
        });
      },

      resetFormState() {
        const form = document.getElementById('obituary-form');
        if (form) {
          form.reset();
        }
      },

      handleCreateNew() {
        this.currentObituaryId = null;
        this.currentStep = 1;
        this.resetFormState();
        this.removePhoto();
        const otherVenueContainer = document.getElementById('other-venue-type-container');
        if (otherVenueContainer) {
          otherVenueContainer.classList.add('hidden');
        }
        const otherVenueInput = document.querySelector('input[name="frontCover.venue.otherType"]');
        if (otherVenueInput) {
          otherVenueInput.required = false;
          otherVenueInput.value = '';
        }
        this.updateAllFormattedDisplays();
        this.updateProgressUI();
        document.querySelectorAll('.form-step').forEach(step => step.classList.remove('active'));
        const firstStep = document.getElementById('step-1');
        if (firstStep) {
          firstStep.classList.add('active');
        }
        this.showView('form-view');
      },

      async handleEdit(id) {
        if (!this.user) {
          this.notify('Please sign in again to edit this program.', 'error');
          this.showView('login-view');
          return;
        }
        const form = document.getElementById('obituary-form');
        if (!form) {
          console.error('Obituary form element is missing.');
          this.notify('Program form is unavailable. Please refresh the page and try again.', 'error');
          return;
        }

        const loadProgramIntoForm = (programData) => {
          this.currentObituaryId = id;
          this.currentStep = 1;
          this.resetFormState();
          try {
            this.populateForm(programData);
          } catch (populationError) {
            console.error('Error populating form data:', populationError);
          }
          this.updateAllFormattedDisplays();
          this.updateProgressUI();
          document.querySelectorAll('.form-step').forEach(step => step.classList.remove('active'));
          const firstStep = document.getElementById('step-1');
          if (firstStep) {
            firstStep.classList.add('active');
          }
          this.showView('form-view');
        };

        const tryLoadCachedProgram = () => {
          if (!this.obituariesCache) return false;
          const cached = this.obituariesCache.get(id);
          if (!cached) return false;
          loadProgramIntoForm(cached);
          return true;
        };

        try {
          this.showView('loading-view');
          const docRef = doc(this.db, 'users', this.user.uid, 'obituaries', id);
          const docSnap = await getDoc(docRef);
          if (docSnap.exists()) {
            const programData = docSnap.data();
            if (this.obituariesCache) {
              this.obituariesCache.set(id, programData);
            }
            loadProgramIntoForm(programData);
          } else if (!tryLoadCachedProgram()) {
            this.notify("Program not found.", "error");
            this.showView('dashboard-view');
          }
        } catch (error) {
          console.error("Error loading for edit:", error);
          if (!tryLoadCachedProgram()) {
            this.notify("Could not load program for editing.", "error");
            this.showView('dashboard-view');
          }
        }
      },

      async handleDelete(deleteButton) {
        const id = deleteButton.dataset.id;
        if (deleteButton.dataset.confirming) {
          try {
            await deleteDoc(doc(this.db, 'users', this.user.uid, 'obituaries', id));
            this.notify("Program deleted successfully.", "success");
          } catch (error) {
            console.error("Error deleting program: ", error);
            this.notify("Could not delete program.", "error");
          }
        } else {
          deleteButton.textContent = 'Confirm Delete?';
          deleteButton.classList.remove('bg-red-100', 'text-red-700');
          deleteButton.classList.add('bg-red-600', 'text-white');
          deleteButton.dataset.confirming = 'true';

          setTimeout(() => {
            if (deleteButton.dataset.confirming) {
              deleteButton.textContent = 'Delete';
              deleteButton.classList.add('bg-red-100', 'text-red-700');
              deleteButton.classList.remove('bg-red-600', 'text-white');
              delete deleteButton.dataset.confirming;
            }
          }, 3000);
        }
      },

      bindFormNavigation() {
        document.querySelectorAll('.next-button').forEach(btn => btn.addEventListener('click', () => this.goToNextStep()));
        document.querySelectorAll('.prev-button').forEach(btn => btn.addEventListener('click', () => this.goToPrevStep()));
        document.querySelectorAll('.save-progress-button').forEach(btn => btn.addEventListener('click', () => this.saveProgress()));
        
        // Bind finished button
        const finishedBtn = document.getElementById('finished-button');
        if (finishedBtn) {
          finishedBtn.addEventListener('click', () => this.handleFinished());
        }
        
        // Bind download PDF button
        const downloadBtn = document.getElementById('download-pdf-button');
        if (downloadBtn) {
          downloadBtn.addEventListener('click', () => this.generatePDF());
        }
        
        // Define step titles
        this.stepTitles = {
          1: "Front Cover Details",
          2: "Life Story Information",
          3: "Professional Life",
          4: "Faith & Community",
          5: "Order of Service",
          6: "Program Back Cover"
        };
      },

      goToNextStep() {
        if (!this.validateStep(this.currentStep)) {
          this.notify('Please fill out all required fields.', 'error');
          return;
        }
        if (this.currentStep < this.totalSteps) {
          document.getElementById(`step-${this.currentStep}`).classList.remove('active');
          this.currentStep++;
          document.getElementById(`step-${this.currentStep}`).classList.add('active');
          this.updateProgressUI();
          window.scrollTo({ top: 0, behavior: 'smooth' });
          
          // Sync Step 1 data to Step 2 when entering Step 2
          if (this.currentStep === 2) {
            this.syncStep1ToStep2();
          }
        }
      },

      goToPrevStep() {
        if (this.currentStep > 1) {
          document.getElementById(`step-${this.currentStep}`).classList.remove('active');
          this.currentStep--;
          document.getElementById(`step-${this.currentStep}`).classList.add('active');
          this.updateProgressUI();
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      },

      validateStep(stepNumber) {
        let isValid = true;
        const stepContainer = document.getElementById(`step-${stepNumber}`);
        stepContainer.querySelectorAll('[required]').forEach(input => {
          input.classList.remove('error-border');
          if (!input.value.trim()) {
            isValid = false;
            input.classList.add('error-border');
          }
        });
        return isValid;
      },

      updateProgressUI() {
        const progress = this.totalSteps > 1 ? (this.currentStep - 1) / (this.totalSteps - 1) * 100 : 0;
        document.getElementById('progress-bar').style.width = `${progress}%`;
        document.getElementById('step-counter').textContent = `Step ${this.currentStep} of ${this.totalSteps}`;
        
        // Update step indicator
        const stepTitle = this.stepTitles[this.currentStep] || "Step";
        document.getElementById('current-step-title').textContent = `Step ${this.currentStep}: ${stepTitle}`;
        document.getElementById('step-count-display').textContent = `Step ${this.currentStep} of ${this.totalSteps}`;
      },

      handleFinished() {
        // Hide the form and show the download section
        document.getElementById('obituary-form').classList.add('hidden');
        document.getElementById('step-indicator').classList.add('hidden');
        document.getElementById('download-section').classList.remove('hidden');
        
        // Scroll to download section
        document.getElementById('download-section').scrollIntoView({ behavior: 'smooth', block: 'center' });
      },

      async generatePDF() {
        try {
          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF({
            orientation: 'portrait',
            unit: 'in',
            format: 'letter'
          });

          const formData = this.getFormData();
          
          // Page 1: Basic Information (Front Cover)
          pdf.setFontSize(16);
          pdf.text('In Loving Memory', 4.25, 1.5, { align: 'center' });
          
          pdf.setFontSize(14);
          const fullName = formData.frontCover?.fullName || 'Name';
          pdf.text(fullName, 4.25, 2, { align: 'center' });
          
          pdf.setFontSize(11);
          const dob = this.formatDate(formData.frontCover?.dob) || '';
          const dop = this.formatDate(formData.frontCover?.dop) || '';
          pdf.text(`${dob} - ${dop}`, 4.25, 2.5, { align: 'center' });

          // Add service details
          pdf.setFontSize(10);
          let yPos = 3.5;
          
          if (formData.frontCover?.service?.dateRaw) {
            const serviceDate = this.formatDate(formData.frontCover.service.dateRaw);
            const serviceTime = formData.frontCover.service?.timeStandard || '';
            pdf.text(`Service: ${serviceDate} at ${serviceTime}`, 4.25, yPos, { align: 'center' });
            yPos += 0.3;
          }
          
          if (formData.frontCover?.venue?.name) {
            pdf.text(formData.frontCover.venue.name, 4.25, yPos, { align: 'center' });
            yPos += 0.3;
            
            if (formData.frontCover.venue.street) {
              pdf.text(formData.frontCover.venue.street, 4.25, yPos, { align: 'center' });
              yPos += 0.3;
            }
            
            const cityStateZip = [
              formData.frontCover.venue.city,
              formData.frontCover.venue.state,
              formData.frontCover.venue.zip
            ].filter(Boolean).join(', ');
            
            if (cityStateZip) {
              pdf.text(cityStateZip, 4.25, yPos, { align: 'center' });
              yPos += 0.3;
            }
          }

          // Page 2: Obituary
          pdf.addPage();
          pdf.setFontSize(14);
          pdf.text('Obituary', 4.25, 1, { align: 'center' });
          
          pdf.setFontSize(10);
          const obituary = formData.generatedObituary || 'No obituary text provided.';
          const splitObituary = pdf.splitTextToSize(obituary, 6.5);
          pdf.text(splitObituary, 1, 1.5);

          // Page 3: Order of Service
          pdf.addPage();
          pdf.setFontSize(14);
          pdf.text('Order of Service', 4.25, 1, { align: 'center' });
          
          pdf.setFontSize(10);
          yPos = 1.5;
          
          const serviceItems = document.querySelectorAll('.service-item');
          serviceItems.forEach((item, index) => {
            const itemName = item.querySelector('input[name*=".itemName"]')?.value || 'Untitled';
            const personName = item.querySelector('input[name*=".personName"]')?.value || '';
            const additionalInfo = item.querySelector('input[name*=".additionalInfo"]')?.value || '';
            
            let text = `${index + 1}. ${itemName}`;
            if (personName) text += ` - ${personName}`;
            if (additionalInfo) text += ` (${additionalInfo})`;
            
            const splitText = pdf.splitTextToSize(text, 6.5);
            pdf.text(splitText, 1, yPos);
            yPos += 0.3 * splitText.length;
            
            if (yPos > 10) {
              pdf.addPage();
              yPos = 1;
            }
          });

          // Page 4: Back Cover
          pdf.addPage();
          pdf.setFontSize(10);
          const backCover = formData.backCover?.content || '';
          const splitBackCover = pdf.splitTextToSize(backCover, 6.5);
          pdf.text(splitBackCover, 1, 1.5);

          // Save the PDF
          const fileName = `${fullName.replace(/\s+/g, '_')}_Program.pdf`;
          pdf.save(fileName);
          
          this.notify('PDF downloaded successfully!', 'success');
        } catch (error) {
          console.error('Error generating PDF:', error);
          this.notify('There was an error generating the PDF. Please try again.', 'error');
        }
      },

      getFormData() {
        const form = document.getElementById('obituary-form');
        const formData = new FormData(form);
        const data = {};
        for (let [key, value] of formData.entries()) {
          if (key === 'photo-upload') continue;
          const keys = key.split('.');
          keys.reduce((acc, currentKey, index) => {
            if (index === keys.length - 1) {
              acc[currentKey] = value;
            } else {
              acc[currentKey] = acc[currentKey] || {};
            }
            return acc[currentKey];
          }, data);
        }

        if (data.frontCover && data.frontCover.venue) {
          const venue = data.frontCover.venue;
          if (venue.type === 'Other' && venue.otherType) {
            venue.type = venue.otherType;
          }
          delete venue.otherType;
        }

        return data;
      },

      populateForm(data) {
        const form = document.getElementById('obituary-form');
        const traverseAndSet = (obj, path = '') => {
          for (const key in obj) {
            const newPath = path ? `${path}.${key}` : key;
            if (typeof obj[key] === 'object' && obj[key] !== null && !Array.isArray(obj[key])) {
              traverseAndSet(obj[key], newPath);
            } else {
              const input = form.querySelector(`[name="${newPath}"]`);
              if (input) {
                if (input.type === 'radio') {
                  const radioToSelect = form.querySelector(`[name="${newPath}"][value="${obj[key]}"]`);
                  if (radioToSelect) radioToSelect.checked = true;
                } else if (input.type === 'checkbox') {
                  input.checked = Boolean(obj[key]);
                } else {
                  input.value = obj[key];
                }
              }
            }
          }
        };
        traverseAndSet(data);

        if (data.frontCover && data.frontCover.venue) {
          this.populateVenue(data.frontCover.venue);
        }

        const eulogistRadio = document.querySelector('input[name="eulogistSame"]:checked');
        if (eulogistRadio) {
          eulogistRadio.dispatchEvent(new Event('change'));
        }

        const photoUrl = data.frontCover?.photoUrl;
        if (photoUrl) {
          document.getElementById('photo-upload-area').style.backgroundImage = `url("${photoUrl}")`;
          document.getElementById('photo-placeholder').classList.add('hidden');
          document.getElementById('photo-preview-overlay').classList.remove('hidden');
        } else {
          this.removePhoto();
        }
      },

      async saveProgress() {
        if (!this.user) return this.notify("You must be logged in to save.", "error");

        const formData = this.getFormData();
        formData.updatedAt = serverTimestamp();

        const venueData = formData.frontCover.venue;
        if (venueData && venueData.name && venueData.street) {
          const venuesRef = collection(this.db, "venues");
          const q = query(venuesRef, where("name", "==", venueData.name), where("street", "==", venueData.street));
          const querySnapshot = await getDocs(q);
          if (querySnapshot.empty) {
            await addDoc(venuesRef, venueData);
          }
        }

        try {
          if (this.currentObituaryId) {
            const docRef = doc(this.db, 'users', this.user.uid, 'obituaries', this.currentObituaryId);
            await updateDoc(docRef, formData);
            this.notify("Progress saved successfully!", "success");
          } else {
            formData.createdAt = serverTimestamp();
            const collectionRef = collection(this.db, 'users', this.user.uid, 'obituaries');
            const docRef = await addDoc(collectionRef, formData);
            this.currentObituaryId = docRef.id;
            this.notify("Program created and saved!", "success");
          }
        } catch (error) {
          console.error("Error saving progress:", error);
          this.notify("Could not save progress.", "error");
        }
      },

      bindPhotoUpload() {
        const photoInput = document.getElementById('photo-upload-input');
        const photoUploadArea = document.getElementById('photo-upload-area');

        photoInput?.addEventListener('change', (e) => {
          if (e.target.files && e.target.files[0]) this.handlePhotoUpload(e.target.files[0]);
        });

        photoUploadArea?.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.stopPropagation();
          photoUploadArea.classList.add('border-indigo-600');
        });

        photoUploadArea?.addEventListener('dragleave', (e) => {
          e.preventDefault();
          e.stopPropagation();
          photoUploadArea.classList.remove('border-indigo-600');
        });

        photoUploadArea?.addEventListener('drop', (e) => {
          e.preventDefault();
          e.stopPropagation();
          photoUploadArea.classList.remove('border-indigo-600');
          if (e.dataTransfer.files && e.dataTransfer.files[0]) {
            this.handlePhotoUpload(e.dataTransfer.files[0]);
          }
        });

        document.getElementById('change-photo-btn')?.addEventListener('click', () => photoInput?.click());
        document.getElementById('remove-photo-btn')?.addEventListener('click', () => this.removePhoto());
      },

      async handlePhotoUpload(file) {
        if (!this.user) return this.notify('You must be logged in to upload photos.', 'error');
        if (!file.type.startsWith('image/')) return this.notify('Please select an image file.', 'error');
        if (file.size > 10 * 1024 * 1024) return this.notify('Image must be smaller than 10MB.', 'error');

        const reader = new FileReader();
        reader.onload = (e) => {
          document.getElementById('photo-upload-area').style.backgroundImage = `url(${e.target.result})`;
          document.getElementById('photo-placeholder').classList.add('hidden');
          document.getElementById('photo-preview-overlay').classList.remove('hidden');
        };
        reader.readAsDataURL(file);

        const uniqueId = this.currentObituaryId || `temp_${Date.now()}`;
        const filePath = `users/${this.user.uid}/obituaries/${uniqueId}/${file.name}`;
        const storageRef = ref(this.storage, filePath);
        const uploadTask = uploadBytesResumable(storageRef, file);

        const progressContainer = document.getElementById('photo-upload-progress');
        progressContainer.classList.remove('hidden');

        uploadTask.on('state_changed',
          (snapshot) => {
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            document.getElementById('photo-progress-bar').style.width = progress + '%';
            document.getElementById('upload-percentage').textContent = Math.round(progress) + '%';
          },
          (error) => {
            console.error("Upload failed:", error);
            this.notify('Photo upload failed.', 'error');
            progressContainer.classList.add('hidden');
          },
          async () => {
            const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
            document.getElementById('photo-url-input').value = downloadURL;
            this.notify('Photo uploaded successfully!', 'success');
            setTimeout(() => progressContainer.classList.add('hidden'), 2000);
          }
        );
      },

      removePhoto() {
        const uploadArea = document.getElementById('photo-upload-area');
        if (uploadArea) uploadArea.style.backgroundImage = 'none';
        const placeholder = document.getElementById('photo-placeholder');
        if (placeholder) placeholder.classList.remove('hidden');
        const overlay = document.getElementById('photo-preview-overlay');
        if (overlay) overlay.classList.add('hidden');
        const fileInput = document.getElementById('photo-upload-input');
        if (fileInput) fileInput.value = '';
        const urlInput = document.getElementById('photo-url-input');
        if (urlInput) urlInput.value = '';
      },

      initPhotoEditor() {
        const modal = document.getElementById('photo-editor-modal');
        const editBtn = document.getElementById('edit-photo-btn');
        const closeBtn = document.getElementById('close-editor');
        const cancelBtn = document.getElementById('cancel-edit');
        const applyBtn = document.getElementById('apply-edit');

        editBtn?.addEventListener('click', () => {
          const bgImage = document.getElementById('photo-upload-area').style.backgroundImage;
          if (bgImage && bgImage !== 'none') {
            const imageUrl = bgImage.slice(5, -2);
            this.openPhotoEditor(imageUrl);
          }
        });

        const closeEditor = () => {
          modal.classList.add('hidden');
          if (this.photoEditor) { this.photoEditor.destroy(); this.photoEditor = null; }
        };

        closeBtn?.addEventListener('click', closeEditor);
        cancelBtn?.addEventListener('click', closeEditor);
        applyBtn?.addEventListener('click', () => this.applyPhotoEdits());

        document.querySelectorAll('.editor-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            if (!this.photoEditor) return;
            const { method, option } = e.currentTarget.dataset;
            if (method === 'crop' || method === 'move') {
              document.querySelectorAll('.editor-btn').forEach(b => b.classList.remove('active'));
              e.currentTarget.classList.add('active');
              this.photoEditor.setDragMode(method);
            } else {
              this.photoEditor[method](option ? parseFloat(option) : undefined);
            }
          });
        });
      },

      openPhotoEditor(imageUrl) {
        const modal = document.getElementById('photo-editor-modal');
        const editorImage = document.getElementById('editor-image');
        editorImage.src = imageUrl;
        modal.classList.remove('hidden');
        editorImage.onload = () => {
          if (this.photoEditor) this.photoEditor.destroy();
          this.photoEditor = new Cropper(editorImage, { aspectRatio: 1, viewMode: 1, dragMode: 'crop' });
        };
      },

      applyPhotoEdits() {
        if (!this.photoEditor) return;
        this.photoEditor.getCroppedCanvas({ width: 500, height: 500 }).toBlob((blob) => {
          if (blob) {
            const editedFile = new File([blob], 'edited-photo.jpg', { type: 'image/jpeg' });
            this.handlePhotoUpload(editedFile);
            document.getElementById('photo-editor-modal').classList.add('hidden');
          }
        }, 'image/jpeg');
      },

      updateAllFormattedDisplays() {
        const dateFormatChoice = document.querySelector('input[name="programSettings.dateFormat"]:checked');
        const timeFormatChoice = document.querySelector('input[name="programSettings.timeFormat"]:checked');
        const dateFormat = dateFormatChoice ? dateFormatChoice.value : 'written';
        const timeFormat = timeFormatChoice ? timeFormatChoice.value : 'written';

        const dateTargets = ['dob', 'dop', 'funeralDate'];
        dateTargets.forEach(id => {
          const inputEl = document.querySelector(`input[data-format-target="${id}"]`);
          const displayEl = document.getElementById(`${id.replace('Date', '-date')}-formatted`);
          if (inputEl && displayEl) {
            displayEl.textContent = this.formatDate(inputEl.value, dateFormat);
          }
        });

        const timeInput = document.querySelector('input[data-format-target="time"]');
        const timeDisplay = document.getElementById('time-formatted');
        if (timeInput && timeDisplay) {
          timeDisplay.textContent = this.formatTime(timeInput.value, timeFormat);
        }
      },

      formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(`${dateString}T00:00:00Z`);
        if (Number.isNaN(date.getTime())) return '';
        return date.toLocaleDateString('en-US', {
          weekday: 'long',
          month: 'long',
          day: 'numeric',
          year: 'numeric',
          timeZone: 'UTC'
        });
      },

      calculateAge(birthDateString, deathDateString) {
        if (!birthDateString || !deathDateString) return null;
        
        const birthDate = new Date(`${birthDateString}T00:00:00Z`);
        const deathDate = new Date(`${deathDateString}T00:00:00Z`);
        
        if (Number.isNaN(birthDate.getTime()) || Number.isNaN(deathDate.getTime())) return null;
        
        // Calculate age
        let age = deathDate.getUTCFullYear() - birthDate.getUTCFullYear();
        const monthDiff = deathDate.getUTCMonth() - birthDate.getUTCMonth();
        const dayDiff = deathDate.getUTCDate() - birthDate.getUTCDate();
        
        // Adjust if birthday hasn't occurred yet in the death year
        if (monthDiff < 0 || (monthDiff === 0 && dayDiff < 0)) {
          age--;
        }
        
        return age >= 0 ? age : null;
      },

      formatTime(timeString) {
        if (!timeString) return '';
        const [hoursStr, minutesStr] = timeString.split(':');
        const hours = Number(hoursStr);
        const minutes = Number(minutesStr);
        if (!Number.isFinite(hours) || !Number.isFinite(minutes)) return '';
        const period = this.getTimePeriodLabel(hours);
        const hourWord = this.convertHourToWords(hours);
        if (minutes === 0) {
          return `${hourWord} O'Clock ${period}`;
        }
        const minuteWords = this.convertMinutesToWords(minutes);
        return `${hourWord} ${minuteWords} ${period}`;
      },

      getTimePeriodLabel(hours) {
        if (hours >= 17) return 'in the Evening';
        if (hours >= 12) return 'in the Afternoon';
        return 'in the Morning';
      },

      convertHourToWords(hours) {
        const hourWords = ['Twelve', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine', 'Ten', 'Eleven'];
        const normalized = ((hours % 12) + 12) % 12;
        return hourWords[normalized];
      },

      convertMinutesToWords(minutes) {
        if (!Number.isFinite(minutes)) return '';
        if (minutes === 0) return '';
        const ones = ['Zero', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine', 'Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
        const tens = ['Zero', 'Ten', 'Twenty', 'Thirty', 'Forty', 'Fifty'];
        if (minutes < 10) {
          return `Oh ${ones[minutes]}`;
        }
        if (minutes < 20) {
          return ones[minutes];
        }
        const tenValue = Math.floor(minutes / 10);
        const oneValue = minutes % 10;
        if (oneValue === 0) {
          return tens[tenValue];
        }
        return `${tens[tenValue]}-${ones[oneValue]}`;
      },

      showError(errorDiv, message) {
        errorDiv.textContent = message;
        errorDiv.classList.remove('hidden');
        setTimeout(() => { errorDiv.classList.add('hidden'); }, 5000);
      },

      getErrorMessage(errorCode) {
        const messages = {
          'auth/user-not-found': 'No account found with this email.',
          'auth/wrong-password': 'Incorrect password.',
          'auth/email-already-in-use': 'An account with this email already exists.',
          'auth/weak-password': 'Password should be at least 6 characters.',
          'auth/invalid-email': 'Please enter a valid email address.'
        };
        return messages[errorCode] || 'An error occurred. Please try again.';
      },

      notify(message, type = 'success') {
        const toast = document.createElement('div');
        const colors = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500' };
        toast.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${colors[type] || 'bg-gray-500'} text-white`;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => { toast.remove(); }, 3000);
      },

      // Obituary Generation Functions
      async generateObituary(corrections = null) {
        const generateBtn = document.getElementById('generate-obituary-btn');
        const regenerateBtn = document.getElementById('regenerate-obituary-btn');
        const loadingDiv = document.getElementById('obituary-loading');
        const errorDiv = document.getElementById('obituary-error');
        const previewSection = document.getElementById('obituary-preview-section');
        
        // Show loading state
        loadingDiv.classList.remove('hidden');
        errorDiv.classList.add('hidden');
        if (generateBtn) generateBtn.disabled = true;
        if (regenerateBtn) regenerateBtn.disabled = true;

        try {
          // Collect all form data
          const formData = this.collectAllFormData();
          
          // Build the prompt for AI
          let prompt = this.buildObituaryPrompt(formData);
          
          // If there are corrections, add them to the prompt
          if (corrections) {
            prompt += `\n\nPREVIOUS VERSION CORRECTIONS REQUESTED:\n${corrections}\n\nPlease regenerate the obituary incorporating these corrections while maintaining the overall quality and style.`;
          }

          // Call the AI API (you'll need to implement this with your AI service)
          const obituaryText = await this.callAIService(prompt);
          
          // Display the generated obituary
          document.getElementById('obituary-text').innerHTML = obituaryText;
          previewSection.classList.remove('hidden');
          
          // Clear corrections textarea after successful regeneration
          if (corrections) {
            document.getElementById('obituary-corrections').value = '';
          }
          
          this.notify('Obituary generated successfully!', 'success');
          
        } catch (error) {
          console.error('Error generating obituary:', error);
          errorDiv.querySelector('p').textContent = 'Failed to generate obituary. Please try again.';
          errorDiv.classList.remove('hidden');
          this.notify('Failed to generate obituary', 'error');
        } finally {
          loadingDiv.classList.add('hidden');
          if (generateBtn) generateBtn.disabled = false;
          if (regenerateBtn) regenerateBtn.disabled = false;
        }
      },

      collectAllFormData() {
        const formData = {};
        const form = document.getElementById('obituary-form');
        
        if (!form) return formData;
        
        // Get all form inputs
        const inputs = form.querySelectorAll('input, textarea, select');
        
        inputs.forEach(input => {
          const name = input.name;
          if (!name) return;
          
          let value;
          if (input.type === 'checkbox') {
            value = input.checked;
          } else if (input.type === 'radio') {
            if (input.checked) {
              value = input.value;
            } else {
              return; // Skip unchecked radio buttons
            }
          } else {
            value = input.value;
          }
          
          // Set the value in formData using the name path
          this.setNestedValue(formData, name, value);
        });
        
        return formData;
      },

      setNestedValue(obj, path, value) {
        const keys = path.split('.');
        let current = obj;
        
        for (let i = 0; i < keys.length - 1; i++) {
          const key = keys[i];
          if (!(key in current)) {
            current[key] = {};
          }
          current = current[key];
        }
        
        current[keys[keys.length - 1]] = value;
      },


      buildObituaryPrompt(formData) {
        let prompt = `You are writing an obituary for a FUNERAL PROGRAM (not a death announcement). This will be printed in the actual funeral service booklet.

CRITICAL STYLE REQUIREMENTS:
- DO NOT start with "passed away" or death announcement language
- START with birth information: "was born on [date] in [location] to [parents]"
- Use PAST TENSE throughout the entire obituary
- This is for the funeral program, not a newspaper announcement
- Write in a warm, respectful, and celebratory tone that honors their life

CRITICAL CONTENT REQUIREMENT:
- EVERY piece of information provided below MUST be included in the obituary
- If a field is filled out or a box is checked, it MUST appear in the final text
- Families expect to see everything they provided - do not omit any details
- Weave all information naturally into the narrative

`;
        
        // Personal Information
        if (formData.personal) {
          prompt += `PERSONAL INFORMATION:\n`;
          if (formData.personal.fullLegalName) prompt += `Full Name: ${formData.personal.fullLegalName}\n`;
          if (formData.personal.dateOfBirth) prompt += `Date of Birth: ${formData.personal.dateOfBirth}\n`;
          if (formData.personal.placeOfBirth) prompt += `Place of Birth: ${formData.personal.placeOfBirth}\n`;
          if (formData.personal.dateOfDeath) prompt += `Date of Death: ${formData.personal.dateOfDeath}\n`;
          if (formData.personal.placeOfDeath) prompt += `Place of Death: ${formData.personal.placeOfDeath}\n`;
          if (formData.personal.ageAtPassing) prompt += `Age at Passing: ${formData.personal.ageAtPassing}\n`;
          prompt += `\n`;
        }

        // Determine if this is clergy/religious leader
        const isClergy = formData.career && formData.career.positions && 
          Object.values(formData.career.positions).some(pos => 
            pos.title && (pos.title.toLowerCase().includes('pastor') || 
                         pos.title.toLowerCase().includes('bishop') || 
                         pos.title.toLowerCase().includes('minister') ||
                         pos.title.toLowerCase().includes('reverend') ||
                         pos.title.toLowerCase().includes('deacon')));

        // Faith Information
        if (formData.faith) {
          prompt += `FAITH & RELIGIOUS BACKGROUND (MUST INCLUDE ALL):\n`;
          if (formData.faith.religiousAffiliation) prompt += `Religious Affiliation: ${formData.faith.religiousAffiliation}\n`;
          if (formData.faith.religiousAffiliationOther) prompt += `Details: ${formData.faith.religiousAffiliationOther}\n`;
          if (formData.faith.baptismDate) prompt += `Baptism Date: ${formData.faith.baptismDate}\n`;
          if (formData.faith.baptismLocation) prompt += `Baptism Location: ${formData.faith.baptismLocation}\n`;
          if (formData.faith.confirmationDate) prompt += `Confirmation Date: ${formData.faith.confirmationDate}\n`;
          if (formData.faith.homeChurch) prompt += `Home Church: ${formData.faith.homeChurch}\n`;
          if (formData.faith.currentChurch) prompt += `Current Church: ${formData.faith.currentChurch}\n`;
          if (formData.faith.ministries) prompt += `Church Ministries/Involvement: ${formData.faith.ministries}\n`;
          prompt += `\n`;
        }

        // Family Information - Parents
        if (formData.surviving && formData.surviving.parents) {
          prompt += `PARENTS (MUST INCLUDE ALL):\n`;
          Object.values(formData.surviving.parents).forEach(parent => {
            if (parent.name) {
              prompt += `  - ${parent.relationship || 'Parent'}: ${parent.name}`;
              if (parent.deceased) prompt += ` (Deceased - use "late" prefix in opening sentence)`;
              prompt += `\n`;
            }
          });
          prompt += `\n`;
        }

        // Siblings who preceded in death
        if (formData.surviving && formData.surviving.siblings) {
          const deceasedSiblings = Object.values(formData.surviving.siblings).filter(s => s.deceased && s.name);
          if (deceasedSiblings.length > 0) {
            prompt += `PRECEDED IN DEATH BY (Siblings) - MUST LIST ALL:\n`;
            deceasedSiblings.forEach(sibling => {
              prompt += `  - ${sibling.name}`;
              if (sibling.relationshipType) prompt += ` (${sibling.relationshipType})`;
              prompt += `\n`;
            });
            prompt += `\n`;
          }
        }

        // Education
        if (formData.education && formData.education.colleges) {
          prompt += `EDUCATION (MUST INCLUDE ALL SCHOOLS):\n`;
          Object.values(formData.education.colleges).forEach(college => {
            if (college.schoolName) {
              prompt += `  - ${college.schoolName}`;
              if (college.degree) prompt += `, ${college.degree}`;
              if (college.graduationYear) prompt += ` (Class of ${college.graduationYear})`;
              if (college.honors) prompt += ` - ${college.honors}`;
              prompt += `\n`;
            }
          });
          prompt += `\n`;
        }

        // Career
        if (formData.career && formData.career.positions) {
          prompt += `CAREER${isClergy ? '/MINISTRY' : ''} (MUST INCLUDE ALL POSITIONS):\n`;
          Object.values(formData.career.positions).forEach(position => {
            if (position.title && position.employer) {
              prompt += `  - ${position.title} at ${position.employer}`;
              if (position.yearsActive) prompt += ` (${position.yearsActive})`;
              if (position.location) prompt += `, ${position.location}`;
              if (position.achievements) prompt += ` - Achievements: ${position.achievements}`;
              prompt += `\n`;
            }
          });
          prompt += `\n`;
        }

        // Marriage Information
        if (formData.surviving && formData.surviving.marriageStatus === 'yes' && formData.surviving.spouse) {
          prompt += `MARRIAGE (MUST INCLUDE ALL DETAILS):\n`;
          if (formData.surviving.spouse.marriageDate) prompt += `Marriage Date: ${formData.surviving.spouse.marriageDate}\n`;
          if (formData.surviving.spouse.name) prompt += `Spouse: ${formData.surviving.spouse.name}\n`;
          if (formData.surviving.spouse.marriageLocation) prompt += `Marriage Location: ${formData.surviving.spouse.marriageLocation}\n`;
          if (formData.surviving.spouse.marriageDetails) prompt += `Marriage Details: ${formData.surviving.spouse.marriageDetails}\n`;
          if (formData.surviving.spouse.childrenFromUnion) prompt += `Children from this union: ${formData.surviving.spouse.childrenFromUnion}\n`;
          if (formData.surviving.spouse.deceased) {
            prompt += `Spouse Status: Deceased`;
            if (formData.surviving.spouse.deathDate) prompt += ` (${formData.surviving.spouse.deathDate})`;
            prompt += ` - Include in "preceded in death" section\n`;
          }
          prompt += `\n`;
        }

        // Military Service
        if (formData.career && formData.career.militaryService) {
          prompt += `MILITARY SERVICE (MUST INCLUDE):\n`;
          if (formData.career.militaryBranch) prompt += `Branch: ${formData.career.militaryBranch}\n`;
          if (formData.career.militaryRank) prompt += `Rank: ${formData.career.militaryRank}\n`;
          if (formData.career.militaryYears) prompt += `Years of Service: ${formData.career.militaryYears}\n`;
          if (formData.career.militaryHonors) prompt += `Honors: ${formData.career.militaryHonors}\n`;
          prompt += `\n`;
        }

        // Hobbies & Interests
        if (formData.hobbies) {
          let hasHobbies = false;
          let hobbiesList = [];
          
          if (formData.hobbies.selectedHobbies) {
            Object.entries(formData.hobbies.selectedHobbies).forEach(([hobby, checked]) => {
              if (checked) {
                hasHobbies = true;
                hobbiesList.push(hobby);
              }
            });
          }
          if (formData.hobbies.other) {
            hasHobbies = true;
            hobbiesList.push(formData.hobbies.other);
          }
          
          if (hasHobbies) {
            prompt += `HOBBIES & INTERESTS (MUST INCLUDE ALL):\n`;
            hobbiesList.forEach(hobby => {
              prompt += `  - ${hobby}\n`;
            });
            prompt += `\n`;
          }
        }

        // Organizations & Memberships
        if (formData.career && formData.career.organizations) {
          prompt += `ORGANIZATIONS & MEMBERSHIPS (MUST INCLUDE ALL):\n`;
          Object.values(formData.career.organizations).forEach(org => {
            if (org.name) {
              prompt += `  - ${org.name}`;
              if (org.role) prompt += ` (${org.role})`;
              if (org.years) prompt += ` - ${org.years}`;
              prompt += `\n`;
            }
          });
          prompt += `\n`;
        }

        // Surviving Family - CRITICAL FORMATTING SECTION
        prompt += `SURVIVORS (Those left to cherish memories) - CRITICAL FORMATTING:\n\n`;
        
        // Spouse (if living)
        if (formData.surviving && formData.surviving.marriageStatus === 'yes' && 
            formData.surviving.spouse && formData.surviving.spouse.name && 
            !formData.surviving.spouse.deceased) {
          prompt += `Spouse: ${formData.surviving.spouse.name}`;
          if (formData.surviving.spouse.location) prompt += ` of ${formData.surviving.spouse.location}`;
          prompt += `\n\n`;
        }
        
        // Children - WITH SPECIFIC FORMATTING RULES
        if (formData.surviving && formData.surviving.children) {
          const childrenArray = Object.values(formData.surviving.children).filter(c => c.name);
          
          if (childrenArray.length > 0) {
            prompt += `CHILDREN - CRITICAL FORMATTING RULES:\n`;
            prompt += `FORMAT: List daughters FIRST (oldest to youngest), then sons (oldest to youngest)\n`;
            prompt += `SPOUSE FORMAT: Name (Spouse) of Location\n`;
            prompt += `LOCATION GROUPING: If multiple children from same city, group them: "all of Birmingham, AL"\n\n`;
            
            // Separate daughters and sons
            const daughters = childrenArray.filter(c => c.gender && c.gender.toLowerCase() === 'female');
            const sons = childrenArray.filter(c => c.gender && c.gender.toLowerCase() === 'male');
            const unknownGender = childrenArray.filter(c => !c.gender || (c.gender.toLowerCase() !== 'female' && c.gender.toLowerCase() !== 'male'));
            
            // List daughters
            if (daughters.length > 0) {
              prompt += `Daughters (${daughters.length}):\n`;
              daughters.forEach((daughter, index) => {
                prompt += `  ${index + 1}. ${daughter.name}`;
                if (daughter.spouse) prompt += ` (${daughter.spouse})`;
                if (daughter.location) prompt += ` of ${daughter.location}`;
                if (daughter.relationshipType && daughter.relationshipType !== 'Biological') prompt += ` [${daughter.relationshipType}]`;
                prompt += `\n`;
              });
              prompt += `\n`;
            }
            
            // List sons
            if (sons.length > 0) {
              prompt += `Sons (${sons.length}):\n`;
              sons.forEach((son, index) => {
                prompt += `  ${index + 1}. ${son.name}`;
                if (son.spouse) prompt += ` (${son.spouse})`;
                if (son.location) prompt += ` of ${son.location}`;
                if (son.relationshipType && son.relationshipType !== 'Biological') prompt += ` [${son.relationshipType}]`;
                prompt += `\n`;
              });
              prompt += `\n`;
            }
            
            // List children with unknown gender
            if (unknownGender.length > 0) {
              prompt += `Children (gender not specified):\n`;
              unknownGender.forEach((child, index) => {
                prompt += `  ${index + 1}. ${child.name}`;
                if (child.spouse) prompt += ` (${child.spouse})`;
                if (child.location) prompt += ` of ${child.location}`;
                if (child.relationshipType && child.relationshipType !== 'Biological') prompt += ` [${child.relationshipType}]`;
                prompt += `\n`;
              });
              prompt += `\n`;
            }
            
            prompt += `IMPORTANT: When writing, count children and use proper grammar:\n`;
            prompt += `- If 1 daughter: "one daughter" or "a daughter"\n`;
            prompt += `- If 2+ daughters: "two daughters" or "[number] daughters"\n`;
            prompt += `- Same for sons\n`;
            prompt += `- Use semicolons (;) between each child\n`;
            prompt += `- If multiple children from same location, group them: "all of Birmingham, AL"\n\n`;
          }
        }
        
        // Grandchildren
        if (formData.surviving && formData.surviving.grandchildren) {
          const grandchildrenList = Object.values(formData.surviving.grandchildren).filter(gc => gc.name);
          if (grandchildrenList.length > 0) {
            prompt += `GRANDCHILDREN (MUST LIST ALL ${grandchildrenList.length}):\n`;
            grandchildrenList.forEach((grandchild, index) => {
              prompt += `  ${index + 1}. ${grandchild.name}`;
              if (grandchild.location) prompt += ` of ${grandchild.location}`;
              prompt += `\n`;
            });
            prompt += `\nFormat: Use semicolons between names. Group by location if multiple from same city.\n\n`;
          }
        }
        
        // Great-grandchildren
        if (formData.surviving && formData.surviving.greatGrandchildren) {
          const greatGrandchildrenList = Object.values(formData.surviving.greatGrandchildren).filter(ggc => ggc.name);
          if (greatGrandchildrenList.length > 0) {
            prompt += `GREAT-GRANDCHILDREN (MUST LIST ALL ${greatGrandchildrenList.length}):\n`;
            greatGrandchildrenList.forEach((ggc, index) => {
              prompt += `  ${index + 1}. ${ggc.name}`;
              if (ggc.location) prompt += ` of ${ggc.location}`;
              prompt += `\n`;
            });
            prompt += `\n`;
          }
        }
        
        // Living Siblings
        if (formData.surviving && formData.surviving.siblings) {
          const livingSiblings = Object.values(formData.surviving.siblings).filter(s => !s.deceased && s.name);
          if (livingSiblings.length > 0) {
            prompt += `SIBLINGS - LIVING (MUST LIST ALL ${livingSiblings.length}):\n`;
            livingSiblings.forEach((sibling, index) => {
              prompt += `  ${index + 1}. ${sibling.name}`;
              if (sibling.spouse) prompt += ` (${sibling.spouse})`;
              if (sibling.location) prompt += ` of ${sibling.location}`;
              if (sibling.relationshipType) prompt += ` [${sibling.relationshipType}]`;
              prompt += `\n`;
            });
            prompt += `\nSeparate by gender if specified: Sisters first, then Brothers\n\n`;
          }
        }
        
        // Extended Family
        if (formData.surviving && formData.surviving.extendedFamily) {
          const extendedList = Object.values(formData.surviving.extendedFamily).filter(ef => ef.name);
          if (extendedList.length > 0) {
            prompt += `EXTENDED FAMILY (MUST LIST ALL):\n`;
            extendedList.forEach((person, index) => {
              prompt += `  ${index + 1}. ${person.relationship}: ${person.name}`;
              if (person.location) prompt += ` of ${person.location}`;
              prompt += `\n`;
            });
            prompt += `\n`;
          }
        }
        
        prompt += `ENDING: Always end survivors section with "and a host of nieces, nephews, cousins, other relatives and friends."\n`;
        if (isClergy) {
          prompt += `For clergy, also add: "and church family" before the period.\n`;
        }
        prompt += `\n`;

        // Additional Information
        if (formData.additional && formData.additional.otherInformation) {
          prompt += `ADDITIONAL INFORMATION (MUST INCLUDE):\n${formData.additional.otherInformation}\n\n`;
        }

        // Final instructions based on person's background
        if (isClergy) {
          prompt += `
OBITUARY STRUCTURE FOR CLERGY/RELIGIOUS LEADER (Write 600-1000 words):

1. OPENING: Start with "[Title] [Full Name] was born on [date] in [location] to [parents names with "late" prefix if deceased]."

2. EARLY RELIGIOUS LIFE: Describe when they accepted Christ and their early church involvement. MUST mention home church where they grew up.

3. EDUCATION: List ALL educational institutions chronologically, including seminaries, with graduation years (e.g., "Class of 1997"). Include ALL honors mentioned.

4. ORDINATION/CALLING: If applicable, describe their ordination - who ordained them, when, where, and their first service/assignment.

5. MINISTRY CAREER: Detail ALL ministry positions chronologically with specific dates, locations, and accomplishments. Include:
   - ALL pastoral assignments with years of service
   - ALL leadership roles in denominational organizations
   - ALL special appointments or honors
   - ALL community involvement mentioned

6. MARRIAGE & FAMILY: Describe their marriage - date, location, spouse's full name. Mention children born from the union.

7. MILITARY SERVICE: If provided, include ALL details about their service.

8. HOBBIES/INTERESTS: Include ALL hobbies and interests mentioned.

9. ORGANIZATIONS: Include ALL organizations and memberships.

10. CHARACTER & LEGACY: Include 2-3 sentences about their personality, ministry style, or impact on others.

11. PRECEDED IN DEATH: List ALL deceased family members with full names.

12. SURVIVORS: CRITICAL FORMATTING - Follow these rules EXACTLY:
    - Begin with "Those left to cherish precious memories..." or similar phrase
    - Spouse with location (if living)
    - Count and state number: "one daughter" or "three daughters"
    - DAUGHTERS FIRST (oldest to youngest): Name (Spouse) of Location;
    - SONS SECOND (oldest to youngest): Name (Spouse) of Location;
    - Use semicolons between children
    - If multiple children from same city: "all of Birmingham, AL"
    - Grandchildren with locations
    - Great-grandchildren if provided
    - Siblings separated by gender: Sisters, then Brothers
    - Extended family with relationships
    - End with "and a host of nieces, nephews, cousins, other relatives, friends, and church family."

TONE: Respectful, celebratory of their ministry, warm. Use titles (Bishop, Pastor, Reverend) consistently.
`;
        } else {
          prompt += `
OBITUARY STRUCTURE FOR GENERAL OBITUARY (Write 400-600 words):

1. OPENING: Start with "[Full Name] was born on [date] in [location] to [parents names with "late" prefix if deceased]."
   - If they had many siblings, mention birth order: "was the [ordinal] of [number] children"

2. EARLY LIFE & FAITH: Describe their early religious background - when they accepted Christ, what church they joined. Include ALL church details provided.

3. EDUCATION: List ALL educational background with schools and graduation years. Include ALL honors.

4. CAREER: Describe ALL work history chronologically. Include:
   - ALL job titles and employers
   - ALL years of service
   - ALL retirements mentioned
   - ALL achievements listed

5. MILITARY SERVICE: If provided, include ALL details about their service.

6. MARRIAGE & FAMILY: Describe marriage - "On [date], [name] married [spouse name]." Mention where they married. State "Through this union, the Lord blessed them with [number] children: [names]."

7. HOBBIES/INTERESTS: Include ALL hobbies and interests mentioned.

8. ORGANIZATIONS: Include ALL organizations and memberships.

9. LIFE TRANSITION (Optional): You may include a respectful phrase like "completed their earthly assignment on [date] and transitioned to their eternal home" OR simply move to survivors section.

10. PRECEDED IN DEATH: If applicable, list ALL deceased family members with full names.

11. SURVIVORS: CRITICAL FORMATTING - Follow these rules EXACTLY:
    - Begin with "Those left to cherish precious memories..." or "[Name] leaves to mourn his/her passing:"
    - Spouse with location (if living)
    - Count and state number: "one son" or "two daughters"
    - DAUGHTERS FIRST (oldest to youngest): Name (Spouse) of Location;
    - SONS SECOND (oldest to youngest): Name (Spouse) of Location;
    - Use semicolons (;) between each child
    - If multiple children from same city: "all of Birmingham, AL"
    - Example: "She leaves to cherish her memories one daughter Vada (Jada) McDaniel of Birmingham, AL; two sons: John (Mary) Smith and David (Lisa) Smith, both of Atlanta, GA;"
    - Grandchildren with locations (use semicolons)
    - Great-grandchildren if provided
    - Siblings: Sisters first, then Brothers with locations
    - Extended family with relationships
    - End with "as well as a host of nieces, nephews, cousins, other relatives and friends."

CRITICAL FORMATTING EXAMPLES:
✓ CORRECT: "one daughter Vada (Jada) McDaniel of Birmingham, AL"
✓ CORRECT: "two sons: John (Mary) Smith of Atlanta, GA and David Smith of Memphis, TN"
✓ CORRECT: "three daughters, all of Birmingham, AL"
✗ WRONG: "Vada McDaniel (spouse: Jada)"
✗ WRONG: Children listed without counting them first

IMPORTANT STYLE NOTES:
- Use respectful titles: "Mr.", "Mrs.", "Ms.", "Brother", "Sister", "Mother" as culturally appropriate
- ALWAYS include spouses in parentheses next to the person's name
- ALWAYS include locations for family members when provided
- Use semicolons between family members in the same category
- Group by location when multiple people from same city
- Write in PAST TENSE throughout
- Include EVERY detail provided - families expect to see everything they entered

DO NOT:
- Start with death announcement
- Use markdown formatting
- Create bullet points or numbered lists in the final obituary
- Omit ANY information that was provided
- Write in present tense
- Skip any checked boxes or filled fields
`;
        }

        return prompt;
      },

      async callAIService(prompt) {
        // Call our secure backend function instead of calling Claude API directly
        // This keeps the API key secure on the server
        const API_URL = '/.netlify/functions/generate-obituary';
        
        try {
          const response = await fetch(API_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              prompt: prompt
            })
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            console.error('Backend API Error:', errorData);
            throw new Error(`API request failed: ${response.status} - ${errorData.error || 'Unknown error'}`);
          }

          const data = await response.json();
          
          // Extract the generated text from the backend response
          if (data.text) {
            let generatedText = data.text;
            
            // Convert markdown formatting to HTML for better display
            generatedText = generatedText
              .replace(/\n\n/g, '</p><p>')  // Convert double newlines to paragraphs
              .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // Convert **bold**
              .replace(/\*(.*?)\*/g, '<em>$1</em>')  // Convert *italic*
              .replace(/\n/g, '<br>');  // Convert single newlines to breaks
            
            // Wrap in paragraph tags if not already
            if (!generatedText.startsWith('<p>')) {
              generatedText = '<p>' + generatedText + '</p>';
            }
            
            return generatedText;
          } else {
            throw new Error('Unexpected API response structure');
          }
          
        } catch (error) {
          console.error('Error calling backend API:', error);
          
          // Provide helpful error messages
          if (error.message.includes('401')) {
            throw new Error('API key is invalid. Please check your Claude API key configuration.');
          } else if (error.message.includes('429')) {
            throw new Error('Rate limit exceeded. Please wait a moment and try again.');
          } else if (error.message.includes('500') || error.message.includes('503')) {
            throw new Error('Service is temporarily unavailable. Please try again in a moment.');
          } else {
            throw new Error(`Failed to generate obituary: ${error.message}`);
          }
        }
      },

      setupObituaryGeneration() {
        const generateBtn = document.getElementById('generate-obituary-btn');
        const regenerateBtn = document.getElementById('regenerate-obituary-btn');
        const previewBtn = document.getElementById('preview-obituary-btn');
        const correctionsTextarea = document.getElementById('obituary-corrections');

        if (generateBtn) {
          generateBtn.addEventListener('click', () => {
            this.generateObituary();
          });
        }

        if (regenerateBtn) {
          regenerateBtn.addEventListener('click', () => {
            const corrections = correctionsTextarea ? correctionsTextarea.value.trim() : '';
            if (corrections) {
              this.generateObituary(corrections);
            } else {
              this.notify('Please enter your corrections before regenerating', 'info');
            }
          });
        }

        if (previewBtn) {
          previewBtn.addEventListener('click', () => {
            // Create a modal or new window to show full preview
            const obituaryText = document.getElementById('obituary-text').innerHTML;
            const previewWindow = window.open('', 'Obituary Preview', 'width=800,height=600');
            previewWindow.document.write(`
              <!DOCTYPE html>
              <html>
              <head>
                <title>Obituary Preview</title>
                <style>
                  body {
                    font-family: 'Merriweather', serif;
                    max-width: 800px;
                    margin: 40px auto;
                    padding: 20px;
                    line-height: 1.8;
                  }
                  h1 {
                    text-align: center;
                    margin-bottom: 30px;
                  }
                </style>
                <link href="https://fonts.googleapis.com/css2?family=Merriweather&display=swap" rel="stylesheet">
              </head>
              <body>
                <h1>Obituary Preview</h1>
                ${obituaryText}
              </body>
              </html>
            `);
            previewWindow.document.close();
          });
        }
      },

      // ========== STEP 5: ORDER OF SERVICE ==========
      
      initOrderOfService() {
        this.serviceItemCounter = 1;
        
        // Add Service Item button
        const addBtn = document.getElementById('add-service-item');
        if (addBtn) {
          addBtn.addEventListener('click', () => this.addServiceItem());
        }

        // Bind existing items
        this.bindServiceItemEvents();
        
        // Initialize drag and drop
        this.initDragAndDrop();
        
        // Update preview on load
        this.updateServicePreview();
      },

      addServiceItem() {
        const container = document.getElementById('order-of-service-container');
        if (!container) return;
        
        const newIndex = this.serviceItemCounter;
        
        const itemHTML = `
          <div class="service-item p-4 border-2 border-gray-300 rounded-lg bg-gray-50" data-index="${newIndex}" draggable="true">
            <div class="flex items-center mb-3">
              <div class="drag-handle cursor-move mr-3 text-gray-400 hover:text-gray-600" title="Drag to reorder">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"></path>
                </svg>
              </div>
              <span class="text-lg font-semibold text-gray-700">Service Item #<span class="item-number">${newIndex + 1}</span></span>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
              <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">Service Item</label>
                <input type="text" name="orderOfService.${newIndex}.itemName" class="w-full p-2 border rounded-lg bg-white" placeholder="e.g., Old Testament Scripture Reading" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">Person Performing</label>
                <input type="text" name="orderOfService.${newIndex}.personName" class="w-full p-2 border rounded-lg bg-white" placeholder="Enter name" />
              </div>
            </div>

            <div class="mb-3">
              <label class="flex items-center">
                <input type="checkbox" class="additional-info-checkbox mr-2" data-index="${newIndex}" />
                <span class="text-sm font-medium text-gray-700">Additional Information</span>
              </label>
            </div>

            <div class="additional-info-container hidden mt-3">
              <label class="block text-sm font-medium text-gray-600 mb-1">Additional Details (e.g., location, special notes)</label>
              <input type="text" name="orderOfService.${newIndex}.additionalInfo" class="w-full p-2 border rounded-lg bg-white" placeholder="Enter additional details" />
            </div>

            <button type="button" class="remove-service-item mt-3 px-3 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 text-sm">
              Remove Item
            </button>
          </div>
        `;
        
        container.insertAdjacentHTML('beforeend', itemHTML);
        this.serviceItemCounter++;
        
        // Rebind events to new item
        this.bindServiceItemEvents();
        
        // Reinitialize drag and drop
        this.initDragAndDrop();
        
        // Update preview
        this.updateServicePreview();
      },

      bindServiceItemEvents() {
        // Remove buttons
        document.querySelectorAll('.remove-service-item').forEach(button => {
          button.removeEventListener('click', this.boundRemoveServiceItem);
          this.boundRemoveServiceItem = (e) => this.removeServiceItem(e);
          button.addEventListener('click', this.boundRemoveServiceItem);
        });
        
        // Additional info checkboxes
        document.querySelectorAll('.additional-info-checkbox').forEach(checkbox => {
          checkbox.removeEventListener('change', this.boundToggleAdditionalInfo);
          this.boundToggleAdditionalInfo = (e) => this.toggleAdditionalInfo(e);
          checkbox.addEventListener('change', this.boundToggleAdditionalInfo);
        });
        
        // Update preview on input change
        document.querySelectorAll('#order-of-service-container input').forEach(input => {
          input.removeEventListener('input', this.boundUpdatePreview);
          this.boundUpdatePreview = () => this.updateServicePreview();
          input.addEventListener('input', this.boundUpdatePreview);
        });
      },

      removeServiceItem(e) {
        const item = e.target.closest('.service-item');
        if (item) {
          item.remove();
          this.renumberServiceItems();
          this.updateServicePreview();
        }
      },

      toggleAdditionalInfo(e) {
        const checkbox = e.target;
        const item = checkbox.closest('.service-item');
        if (!item) return;
        
        const additionalInfoContainer = item.querySelector('.additional-info-container');
        
        if (checkbox.checked) {
          additionalInfoContainer.classList.remove('hidden');
        } else {
          additionalInfoContainer.classList.add('hidden');
          const input = additionalInfoContainer.querySelector('input');
          if (input) input.value = '';
        }
        
        this.updateServicePreview();
      },

      renumberServiceItems() {
        const items = document.querySelectorAll('.service-item');
        items.forEach((item, index) => {
          const itemNumber = item.querySelector('.item-number');
          if (itemNumber) {
            itemNumber.textContent = index + 1;
          }
          
          item.setAttribute('data-index', index);
          
          item.querySelectorAll('input, textarea').forEach(input => {
            const name = input.getAttribute('name');
            if (name && name.startsWith('orderOfService.')) {
              const newName = name.replace(/orderOfService\.\d+\./, `orderOfService.${index}.`);
              input.setAttribute('name', newName);
            }
          });
          
          const checkbox = item.querySelector('.additional-info-checkbox');
          if (checkbox) {
            checkbox.setAttribute('data-index', index);
          }
        });
      },

      initDragAndDrop() {
        const container = document.getElementById('order-of-service-container');
        if (!container) return;
        
        const items = container.querySelectorAll('.service-item');
        let draggedItem = null;
        
        items.forEach(item => {
          item.setAttribute('draggable', 'true');
          
          item.removeEventListener('dragstart', this.boundDragStart);
          this.boundDragStart = (e) => {
            draggedItem = item;
            item.style.opacity = '0.5';
            e.dataTransfer.effectAllowed = 'move';
          };
          item.addEventListener('dragstart', this.boundDragStart);
          
          item.removeEventListener('dragend', this.boundDragEnd);
          this.boundDragEnd = () => {
            item.style.opacity = '1';
            draggedItem = null;
          };
          item.addEventListener('dragend', this.boundDragEnd);
          
          item.removeEventListener('dragover', this.boundDragOver);
          this.boundDragOver = (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            if (item !== draggedItem && draggedItem) {
              const rect = item.getBoundingClientRect();
              const midpoint = rect.top + rect.height / 2;
              
              if (e.clientY < midpoint) {
                item.parentNode.insertBefore(draggedItem, item);
              } else {
                item.parentNode.insertBefore(draggedItem, item.nextSibling);
              }
            }
          };
          item.addEventListener('dragover', this.boundDragOver);
          
          item.removeEventListener('drop', this.boundDrop);
          this.boundDrop = (e) => {
            e.preventDefault();
            this.renumberServiceItems();
            this.updateServicePreview();
          };
          item.addEventListener('drop', this.boundDrop);
        });
      },

      updateServicePreview() {
        const previewList = document.getElementById('preview-list');
        if (!previewList) return;
        
        previewList.innerHTML = '';
        
        const items = document.querySelectorAll('.service-item');
        
        if (items.length === 0) {
          previewList.innerHTML = '<p class="text-gray-500 italic">No items added yet</p>';
          return;
        }
        
        items.forEach((item) => {
          const itemName = item.querySelector('input[name*=".itemName"]')?.value || 'Untitled Item';
          const personName = item.querySelector('input[name*=".personName"]')?.value || '';
          const additionalInfo = item.querySelector('input[name*=".additionalInfo"]')?.value || '';
          const hasAdditionalInfo = item.querySelector('.additional-info-checkbox')?.checked || false;
          
          let previewHTML = `<li class="text-gray-700"><strong>${itemName}</strong>`;
          
          if (personName) {
            previewHTML += ` - ${personName}`;
          }
          
          if (hasAdditionalInfo && additionalInfo) {
            previewHTML += ` <span class="text-sm text-gray-600">(${additionalInfo})</span>`;
          }
          
          previewHTML += '</li>';
          
          previewList.insertAdjacentHTML('beforeend', previewHTML);
        });
      }
    };

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => App.init());
    } else {
      App.init();
    }
  </script>

  <script> (function () { // Helper: find the adjacent error <small> function getErrorEl(input) { const sib = input.nextElementSibling; return (sib && sib.classList && sib.classList.contains('field-error')) ? sib : null; } function setError(input, msg) { const err = getErrorEl(input); if (!err) return; if (msg) { input.setAttribute('aria-invalid','true'); err.textContent = msg; } else { input.removeAttribute('aria-invalid'); err.textContent = ''; } } function isVisible(el) { if (!el) return false; const style = window.getComputedStyle(el); return el.offsetParent !== null || (style.display !== 'none' && style.visibility !== 'hidden'); } function isFutureDate(val) { const d = new Date(val); if (isNaN(d)) return false; const today = new Date(); today.setHours(0,0,0,0); d.setHours(0,0,0,0); return d.getTime() > today.getTime(); } function validate(el) { const id = el.id || ''; const name = el.name || ''; const type = el.type || ''; // Required: Full Legal Name if (id === 'full-legal-name') { const ok = el.value.trim().length > 0; setError(el, ok ? '' : 'Please enter the full legal name.'); return; } // Required: Date of Birth if (id === 'date-of-birth') { const ok = !!el.value; setError(el, ok ? '' : 'Please select a valid birth date.'); return; } // Date of Death - if present, must not be in the future if (id === 'date-of-death') { if (el.value && isFutureDate(el.value)) { setError(el, 'Date of death cannot be in the future.'); } else { setError(el, ''); } return; } // Graduation Year (Education > College/University) if (/^education\.colleges\.\d+\.graduationYear$/.test(name)) { const ok = /^\d{4}$/.test(el.value.trim()); setError(el, ok || el.value.trim()==='' ? '' : 'Enter a 4-digit year (e.g., 2009).'); return; } // Military Years (Start/End), only if present if (name === 'career.serviceStartYear' || name === 'career.serviceEndYear') { const ok = /^\d{4}$/.test(el.value.trim()); setError(el, ok || el.value.trim()==='' ? '' : 'Enter a 4-digit year (e.g., 2009).'); return; } // Baptism Date (visible only) if (/^faith\.churchMemberships\.\d+\.baptismDate$/.test(name)) { if (isVisible(el)) { if (!el.value || isFutureDate(el.value)) { setError(el, 'Please enter a valid baptism date.'); } else { setError(el, ''); } } else { setError(el, ''); } return; } // Religious Affiliation Other (require when "Other" selected) if (name === 'faith.religiousAffiliationOther') { const select = document.getElementById('religious-affiliation'); const requireOther = select && String(select.value).toLowerCase() === 'other'; const ok = !requireOther || el.value.trim().length > 0; setError(el, ok ? '' : 'Please provide the affiliation details.'); return; } // Got Saved Here? details (e.g., salvationDate), only if present and visible if (/^faith\.churchMemberships\.\d+\.salvationDate$/.test(name) || /salvation/.test(name)) { if (isVisible(el)) { const ok = (el.type === 'date') ? !!el.value : el.value.trim().length > 0; setError(el, ok ? '' : 'Please provide details for this selection.'); } else { setError(el, ''); } return; } } // Event delegation for blur then input-after-blur document.addEventListener('blur', function(e){ const el = e.target; if (!el || !('name' in el || 'id' in el)) return; el.dataset.touched = 'true'; validate(el); }, true); document.addEventListener('input', function(e){ const el = e.target; if (!el || el.dataset.touched !== 'true') return; validate(el); }); // Also revalidate "Other" text when the affiliation changes const aff = document.getElementById('religious-affiliation'); if (aff) { aff.addEventListener('change', function(){ const other = document.querySelector('input[name="faith.religiousAffiliationOther"]'); if (other && other.dataset.touched === 'true') validate(other); }); } })(); </script>
</body>

</html>
